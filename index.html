
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crew Performance Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {font-family: 'Roboto', sans-serif; background:#f5f7fa; color:#1a1a1a; margin:0; padding:0; min-height:100vh;}
    .top-bar {display:flex; flex-wrap:wrap; gap:0.75rem; padding:0.75rem; background:#fff; border-bottom:1px solid #e0e6ef;}
    .header-buttons {display:flex; flex-wrap:wrap; gap:0.5rem; justify-content:center; padding:1rem; background:linear-gradient(to right,#003366,#0074D9);}
    .date-picker, .division-input {padding:0.5rem; font-size:0.95rem; border-radius:0.375rem; border:1px solid #b0c4de; background:#f8fafc; color:#003366; width:200px;}
    .btn, .header-btn {padding:0.5rem 1rem; border-radius:0.375rem; border:1px solid #0074D9; background:#0074D9; color:#fff; font-weight:500; cursor:pointer;}
    .btn:hover, .header-btn:hover {background:#003366; transform:scale(1.05);}
    .filter-btn {padding:0.5rem 1rem; margin:0.25rem; border-radius:0.375rem; border:1px solid #0074D9; background:#e6f0fa; color:#003366; font-weight:500; cursor:pointer;}
    .filter-btn:hover {background:#b0c4de;}
    .filter-btn.active {background:#0074D9; color:#fff; border-color:#003366;}
    .table-container {max-width:98%; margin:1rem auto; background:#fff; border-radius:0.5rem; box-shadow:0 2px 6px rgba(0,51,102,0.1); overflow-x:auto; padding:1rem;}
    table {width:100%; border-collapse:collapse; table-layout:auto;}
    th {background:#0074D9; color:#fff; font-weight:600; cursor:pointer; position:sticky; top:0; z-index:10;}
    th:hover {background:#003366;}
    th, td {border:1px solid #e0e6ef; padding:0.5rem; text-align:center; font-size:0.9rem; min-width:60px;}
    tr:nth-child(even) td {background:#f8fafc;}
    tr:hover td {background:#e6f0fa;}
    .section-header {margin:2rem 0 1rem; font-size:1.5rem; font-weight:600; color:#003366; text-align:center;}
    .button-container {margin:1rem auto; display:flex; flex-wrap:wrap; justify-content:center; gap:0.5rem;}
    .pagination {margin:1rem auto; display:flex; justify-content:center; gap:0.5rem;}
    .pagination-btn {padding:0.5rem 1rem; border-radius:0.375rem; border:1px solid #0074D9; background:#e6f0fa; color:#003366; cursor:pointer;}
    .pagination-btn:hover {background:#b0c4de;}
    .pagination-btn.disabled {background:#d3d3d3; cursor:not-allowed;}
    .division-group-header {background:#e0e6ef; font-weight:bold; text-align:left; padding:0.5rem;}
    .hidden {display:none;}
    .cat-spm {background-color: #e6f3ff; }
    .cat-cvvrs {background-color: #e6ffe6; }
    .cat-mobile {background-color: #fff5e6; }
    .cat-ambush-dfc {background-color: #ffe6e6; }
    .cat-alprs {background-color: #e6e6ff; }
    .cat-memu {background-color: #f0e6ff; }
    .cat-ibh {background-color: #ffffe6; }
    .cat-runningroom {background-color: #e6fff0; }
    .cat-stabling {background-color: #ffe6f0; }
    .cat-shunting {background-color: #e6faff; }
    .modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;}
    .modal-content {background:#fff; padding:1.5rem; border-radius:0.5rem; max-width:600px; width:90%; max-height:80vh; overflow-y:auto;}
    .preview-page {border:1px solid #e0e6ef; padding:0.5rem; margin:0.5rem 0; background:#fff; font-size:0.8rem;}
    .preview-page img {max-width:100%; height:auto; border:1px solid #e0e6ef;}
    .preview-controls {margin-top:1rem; display:flex; flex-direction:column; gap:0.5rem;}
    .preview-controls label {font-weight:500; color:#003366;}
    .preview-controls input[type="range"] {width:100%;}
    .pdf-table {font-size:8px; width:100%; border-collapse:collapse;}
    .pdf-table th, .pdf-table td {border:1px solid #e0e6ef; padding:3px; text-align:center; word-break:break-word; white-space:normal; min-width:60px;}
    .pdf-table th {background:#0074D9; color:#fff;}
    .pdf-table tr:nth-child(even) td {background:#f8fafc;}
    .pdf-table .division-group-header {background:#e0e6ef; text-align:left; font-weight:bold;}
    @media (max-width:768px) {.top-bar,.button-container,.header-buttons{flex-direction:column; align-items:stretch;} .date-picker,.division-input{width:100%;} th,td{font-size:0.8rem; padding:0.4rem;}}
    @media (max-width:480px) {th,td{font-size:0.7rem; padding:0.3rem;} .btn,.header-btn,.filter-btn,.pagination-btn{font-size:0.8rem; padding:0.4rem 0.8rem;}}
  </style>
</head>
<body>
  <div class="header-buttons">
    <button class="header-btn" id="page1Btn">Crew Performance Dashboard</button>
    <button class="header-btn" id="page2Btn">Page 2 (Coming Soon)</button>
    <button class="header-btn" id="page3Btn">Page 3 (Coming Soon)</button>
    <button class="header-btn" id="page4Btn">Page 4 (Coming Soon)</button>
    <button class="header-btn" id="page5Btn">Page 5 (Coming Soon)</button>
  </div>

  <div class="top-bar">
    <input type="text" id="datePicker" class="date-picker" placeholder="Select Date Range">
    <input type="text" id="divisionInput" class="division-input" placeholder="Enter Division (Optional)">
    <button class="btn" id="resetBtn">üîÑ Reset Filters</button>
    <button class="btn" id="excelBtn">üì• Export to Excel</button>
    <button class="btn" id="pdfBtn">üìÑ Export to PDF</button>
    <button class="btn" id="toggleDivisionSummaryBtn" style="font-size: 1.25rem; font-weight: bold; background: linear-gradient(90deg, #ff9800 0%, #ffeb3b 100%); color: #003366; border: 2px solid #ff9800; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);">
      <span style="color: #d32f2f; font-size: 1.5rem; vertical-align: middle;">‚óè</span>
      <span style="vertical-align: middle;">üìä Show Division Summary</span>
    </button>
  </div>

  <div class="table-container">
    <table id="summaryTable" class="pdf-table">
      <thead id="summaryHeader"></thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <h3 class="section-header hidden" id="divisionSummaryHeader">Division-Based Summary</h3>
  <div class="table-container hidden" id="divisionSummaryContainer">
    <table id="divisionSummaryTable" class="pdf-table">
      <thead id="divisionSummaryTableHeader"></thead>
      <tbody id="divisionSummaryTableBody"></tbody>
    </table>
  </div>

  <h3 class="section-header" style="color: red; font-weight: bold; font-size: 1.5rem;">Details of Deficiencies Notice Division wise <span id="live-indicator" style="color: rgb(144, 175, 3); font-size: 1rem; font-weight: bold; margin-left: 10px;">‚óè Table wise data :-(Nos.Of cases).</span></h3>
  <div class="button-container" id="divisionButtons"></div>
  <div class="button-container" id="categoryButtons"></div>
  <div class="table-container">
    <table id="remarksTable" class="pdf-table">
      <thead id="remarksHeader"></thead>
      <tbody id="remarksBody"></tbody>
    </table>
  </div>
  <div class="pagination">
    <button class="pagination-btn" id="prevPageBtn">Previous</button>
    <span id="pageInfo"></span>
    <button class="pagination-btn" id="nextPageBtn">Next</button>
  </div>

  <div id="pdfPreviewModal" class="modal">
    <div class="modal-content">
      <h2>PDF Page Preview</h2>
      <div id="previewContent"></div>
      <div class="preview-controls">
        <label>Font Size (pt): <span id="fontSizeValue">8</span></label>
        <input type="range" id="fontSizeSlider" min="6" max="10" value="8" step="0.5">
        <label>Column Width Multiplier: <span id="columnWidthValue">1.0</span></label>
        <input type="range" id="columnWidthSlider" min="0.8" max="1.5" value="1.0" step="0.1">
        <label>Margins (mm): <span id="marginValue">8</span></label>
        <input type="range" id="marginSlider" min="5" max="12" value="8" step="1">
        <button class="btn" id="confirmPdfBtn">Confirm and Export</button>
        <button class="btn" id="cancelPdfBtn">Cancel</button>
      </div>
    </div>
  </div>

<script>
const { jsPDF } = window.jspdf;
const SHEET_ID = '12mtmU8RBHFLUpFXYCdGH96mMBL_Ec6cpvh0dR_CotZg';
const API_KEY = 'AIzaSyBkKVtdfFbFfdFE8FqSaUGZvptxj0Fysco';
const RANGE = 'Responses!B1:AQ1000';
let allData = [], headers = [], summaryData = [], divisionSummaryData = {}, remarksData = [];
let selectedDivision = '', buttonDivision = 'ALL', buttonCategory = 'ALL';
let fromDate = '', toDate = '', showDivisionSummary = false;
let currentPage = 1, rowsPerPage = 100;
let pdfSettings = { fontSize: 8, columnWidthMultiplier: 1.0, margin: 8 };

// Categories with modified mappings
const categories = [
  { sn: 1, name: 'SPM', checkCol: 3, defCol: 4, remarkCol: 5, class: 'cat-spm' },
  { sn: 2, name: 'CVVRS', checkCol: 6, defCol: 7, remarkCol: 8, class: 'cat-cvvrs' },
  { sn: 3, name: 'Mobile', checkCol: [9, 11, 13, 15, 16], defCol: [10, 12, 14, 17], remarkCol: 18, class: 'cat-mobile' },
  { sn: 4, name: 'Ambush DFC', checkCol: [19, 21], defCol: [20, 22], remarkCol: 23, class: 'cat-ambush-dfc' },
  { sn: 5, name: 'ALP RS', checkCol: 24, defCol: 25, remarkCol: 26, class: 'cat-alprs' },
  { sn: 6, name: 'MEMU', checkCol: 27, defCol: 28, remarkCol: 29, class: 'cat-memu' },
  { sn: 7, name: 'IBH', checkCol: 30, defCol: 31, remarkCol: 32, class: 'cat-ibh' },
  { sn: 8, name: 'Running Room', checkCol: 33, defCol: 34, remarkCol: 35, class: 'cat-runningroom' },
  { sn: 9, name: 'Stabling', checkCol: 36, defCol: 37, remarkCol: 38, class: 'cat-stabling' },
  { sn: 10, name: 'Shunting', checkCol: 39, defCol: 40, remarkCol: 41, class: 'cat-shunting' }
];

async function fetchData() {
  try {
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    const data = await res.json();
    allData = data.values || [];
    if (allData.length === 0) throw new Error('No data received from Google Sheets');
    headers = allData[0] || [];
    initUI();
    renderTables();
  } catch (err) {
    console.error('Fetch Error:', err);
    alert('Error fetching data. Please check your internet connection or try again later.');
  }
}
fetchData();

function addOneDay(dateStr) {
  if (!dateStr) return '';
  let date = new Date(dateStr);
  date.setDate(date.getDate() + 1);
  return date.toISOString().split('T')[0];
}

function initUI() {
  const today = new Date();
  const defaultFrom = new Date();
  defaultFrom.setDate(today.getDate() - 6);
  fromDate = addOneDay(defaultFrom.toISOString().split('T')[0]);
  toDate = addOneDay(today.toISOString().split('T')[0]);

  flatpickr('#datePicker', {
    mode: 'range',
    dateFormat: 'Y-m-d',
    defaultDate: [fromDate, toDate],
    static: true,
    onChange: (selectedDates) => {
      if (selectedDates.length === 2) {
        const inputFrom = selectedDates[0].toISOString().split('T')[0];
        const inputTo = selectedDates[1].toISOString().split('T')[0];
        fromDate = addOneDay(inputFrom);
        toDate = addOneDay(inputTo);
        if (fromDate > toDate) {
          alert('Start date cannot be later than end date.');
          fromDate = toDate;
          document.getElementById('datePicker')._flatpickr.setDate([inputTo, inputTo]);
        }
        currentPage = 1;
        renderTables();
      }
    }
  });

  document.getElementById('divisionInput').addEventListener('input', function() {
    selectedDivision = this.value.trim();
    currentPage = 1;
    renderTables();
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    selectedDivision = '';
    buttonDivision = 'ALL';
    buttonCategory = 'ALL';
    showDivisionSummary = false;
    currentPage = 1;
    document.getElementById('divisionInput').value = '';
    document.getElementById('toggleDivisionSummaryBtn').textContent = 'üìä Show Division Summary';
    document.getElementById('divisionSummaryHeader').classList.add('hidden');
    document.getElementById('divisionSummaryContainer').classList.add('hidden');
    const today = new Date();
    const defaultFrom = new Date();
    defaultFrom.setDate(today.getDate() - 6);
    fromDate = addOneDay(defaultFrom.toISOString().split('T')[0]);
    toDate = addOneDay(today.toISOString().split('T')[0]);
    document.getElementById('datePicker')._flatpickr.setDate([fromDate, toDate]);
    renderTables();
  });

  document.getElementById('toggleDivisionSummaryBtn').addEventListener('click', () => {
    showDivisionSummary = !showDivisionSummary;
    document.getElementById('toggleDivisionSummaryBtn').textContent = showDivisionSummary ? 'üìä Hide Division Summary' : 'üìä Show Division Summary';
    document.getElementById('divisionSummaryHeader').classList.toggle('hidden', !showDivisionSummary);
    document.getElementById('divisionSummaryContainer').classList.toggle('hidden', !showDivisionSummary);
    renderTables();
  });

  document.getElementById('excelBtn').addEventListener('click', exportToExcel);
  document.getElementById('pdfBtn').addEventListener('click', showPdfPreview);

  document.getElementById('prevPageBtn').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderTables();
    }
  });

  document.getElementById('nextPageBtn').addEventListener('click', () => {
    if (currentPage < Math.ceil(remarksData.length / rowsPerPage)) {
      currentPage++;
      renderTables();
    }
  });

  document.getElementById('page1Btn').addEventListener('click', () => {
    window.location.reload();
  });
  ['page2Btn', 'page3Btn', 'page4Btn', 'page5Btn'].forEach(id => {
    document.getElementById(id).addEventListener('click', () => {
      alert('Coming Soon');
    });
  });

  document.getElementById('fontSizeSlider').addEventListener('input', function() {
    pdfSettings.fontSize = parseFloat(this.value);
    document.getElementById('fontSizeValue').textContent = this.value;
    showPdfPreview();
  });
  document.getElementById('columnWidthSlider').addEventListener('input', function() {
    pdfSettings.columnWidthMultiplier = parseFloat(this.value);
    document.getElementById('columnWidthValue').textContent = this.value;
    showPdfPreview();
  });
  document.getElementById('marginSlider').addEventListener('input', function() {
    pdfSettings.margin = parseInt(this.value);
    document.getElementById('marginValue').textContent = this.value;
    showPdfPreview();
  });
  document.getElementById('confirmPdfBtn').addEventListener('click', exportToPDF);
  document.getElementById('cancelPdfBtn').addEventListener('click', () => {
    document.getElementById('pdfPreviewModal').style.display = 'none';
  });
}

function renderTables() {
  const divisionData = {};
  allData.slice(1).forEach(r => {
    const date = r[1], division = r[0];
    if (!division || !date) return;
    if (date < fromDate || date > toDate) return;
    if (selectedDivision && division !== selectedDivision) return;

    if (!divisionData[division]) {
      divisionData[division] = categories.reduce((acc, cat) => {
        acc[cat.sn] = { checks: 0, deficiencies: 0 };
        return acc;
      }, {});
    }

    categories.forEach(cat => {
      let checks = 0;
      if (Array.isArray(cat.checkCol)) {
        cat.checkCol.forEach(col => checks += Number(r[col - 1] || 0));
      } else {
        checks = Number(r[cat.checkCol - 1] || 0);
      }
      let deficiencies = 0;
      if (Array.isArray(cat.defCol)) {
        cat.defCol.forEach(col => deficiencies += Number(r[col - 1] || 0));
      } else {
        deficiencies = Number(r[cat.defCol - 1] || 0);
      }
      divisionData[division][cat.sn].checks += checks;
      divisionData[division][cat.sn].deficiencies += deficiencies;
    });
  });

  summaryData = categories.map(cat => {
    const checks = Object.values(divisionData).reduce((sum, div) => sum + div[cat.sn].checks, 0);
    const deficiencies = Object.values(divisionData).reduce((sum, div) => sum + div[cat.sn].deficiencies, 0);
    const divisionsWithDef = Object.keys(divisionData)
      .filter(div => divisionData[div][cat.sn].deficiencies > 0)
      .join(', ');
    return {
      sn: cat.sn,
      category: cat.name,
      checks,
      deficiencies,
      divisionsWithDef: divisionsWithDef || 'None'
    };
  });

  divisionSummaryData = {};
  allData.slice(1).forEach(r => {
    const date = r[1], division = r[0];
    if (!division || !date) return;
    if (date < fromDate || date > toDate) return;
    if (selectedDivision && division !== selectedDivision) return;

    if (!divisionSummaryData[division]) {
      divisionSummaryData[division] = categories.reduce((acc, cat) => {
        acc[cat.name + 'Check'] = 0;
        acc[cat.name + 'Def'] = 0;
        return acc;
      }, {});
    }

    categories.forEach(cat => {
      let checks = 0;
      if (Array.isArray(cat.checkCol)) {
        cat.checkCol.forEach(col => checks += Number(r[col - 1] || 0));
      } else {
        checks = Number(r[cat.checkCol - 1] || 0);
      }
      let deficiencies = 0;
      if (Array.isArray(cat.defCol)) {
        cat.defCol.forEach(col => deficiencies += Number(r[col - 1] || 0));
      } else {
        deficiencies = Number(r[cat.defCol - 1] || 0);
      }
      divisionSummaryData[division][cat.name + 'Check'] += checks;
      divisionSummaryData[division][cat.name + 'Def'] += deficiencies;
    });
  });

  const summaryHeader = document.getElementById('summaryHeader');
  const summaryBody = document.getElementById('summaryBody');
  const excelSummaryData = [];

  summaryHeader.innerHTML = `
    <th onclick="sortTable('sn')">SN</th>
    <th onclick="sortTable('category')">Category</th>
    <th onclick="sortTable('checks')">No of Checks Conducted</th>
    <th onclick="sortTable('deficiencies')">Deficiencies Noticed</th>
    <th onclick="sortTable('divisionsWithDef')">Divisions Deficiencies</th>
  `;

  summaryBody.innerHTML = '';
  if (summaryData.length === 0) {
    summaryBody.innerHTML = `<tr><td colspan="5">No data available for the selected filters.</td></tr>`;
  } else {
    summaryData.forEach(row => {
      const html = `
        <tr>
          <td>${row.sn}</td>
          <td>${row.category}</td>
          <td>${row.checks}</td>
          <td>${row.deficiencies}</td>
          <td>${row.divisionsWithDef}</td>
        </tr>
      `;
      summaryBody.insertAdjacentHTML('beforeend', html);
      excelSummaryData.push({
        SN: row.sn,
        Category: row.category,
        'No of Checks Conducted': row.checks,
        'Deficiencies Noticed': row.deficiencies,
        'Divisions Deficiencies': row.divisionsWithDef
      });
    });
  }

  const divisionSummaryTableHeader = document.getElementById('divisionSummaryTableHeader');
  const divisionSummaryTableBody = document.getElementById('divisionSummaryTableBody');
  const excelDivisionSummaryData = [];

  divisionSummaryTableHeader.innerHTML = `
    <th onclick="sortDivisionTable('division')">Division</th>
    ${categories.map(cat => `
      <th onclick="sortDivisionTable('${cat.name}Check')">${cat.name} Checks</th>
      <th onclick="sortDivisionTable('${cat.name}Def')">${cat.name} Def.</th>
    `).join('')}
  `;

  divisionSummaryTableBody.innerHTML = '';
  if (showDivisionSummary) {
    const divisions = Object.keys(divisionSummaryData).sort((a, b) => divisionSummaryData[b]['SPMCheck'] - divisionSummaryData[a]['SPMCheck']);
    if (divisions.length === 0) {
      divisionSummaryTableBody.innerHTML = `<tr><td colspan="${categories.length * 2 + 1}">No data available for the selected filters.</td></tr>`;
    } else {
      divisions.forEach(division => {
        const g = divisionSummaryData[division];
        let rowHtml = `<tr><td>${division}</td>`;
        const excelRow = { Division: division };
        categories.forEach(cat => {
          rowHtml += `<td>${g[cat.name + 'Check']}</td><td>${g[cat.name + 'Def']}</td>`;
          excelRow[cat.name + ' Checks'] = g[cat.name + 'Check'];
          excelRow[cat.name + ' Def.'] = g[cat.name + 'Def'];
        });
        rowHtml += `</tr>`;
        divisionSummaryTableBody.insertAdjacentHTML('beforeend', rowHtml);
        excelDivisionSummaryData.push(excelRow);
      });
    }
  }

  const divisionCounts = {};
  const categoryCounts = {};
  categories.forEach(cat => categoryCounts[cat.name] = 0);
  const allRemarksData = [];
  const groupedRemarks = {};

  allData.slice(1).forEach(r => {
    const date = r[1], division = r[0];
    if (!division || !date) return;
    if (date < fromDate || date > toDate) return;
    if (selectedDivision && division !== selectedDivision) return;

    let hasDeficiency = false;
    categories.forEach(cat => {
      let def = 0;
      if (Array.isArray(cat.defCol)) {
        cat.defCol.forEach(col => def += Number(r[col - 1] || 0));
      } else {
        def = Number(r[cat.defCol - 1] || 0);
      }
      if (def > 0) hasDeficiency = true;
    });
    if (!hasDeficiency) return;

    const key = `${date}_${division}`;
    if (!groupedRemarks[key]) {
      groupedRemarks[key] = { date, division, categories: [] };
    }

    categories.forEach(cat => {
      let def = 0;
      if (Array.isArray(cat.defCol)) {
        cat.defCol.forEach(col => def += Number(r[col - 1] || 0));
      } else {
        def = Number(r[cat.defCol - 1] || 0);
      }
      if (def > 0) {
        const remark = r[cat.remarkCol - 1] || '';
        if (!groupedRemarks[key].categories.some(c => c.name === cat.name)) {
          groupedRemarks[key].categories.push({ name: cat.name, remark });
          categoryCounts[cat.name] = (categoryCounts[cat.name] || 0) + 1;
          divisionCounts[division] = (divisionCounts[division] || 0) + 1;
        }
      }
    });
  });

  Object.values(groupedRemarks).forEach(g => {
    if (g.categories.length > 0) {
      allRemarksData.push({
        date: g.date,
        division: g.division,
        categories: g.categories
      });
    }
  });

  const divisionButtons = document.getElementById('divisionButtons');
  const uniqueDivisions = [...new Set(summaryData.flatMap(row => row.divisionsWithDef.split(', ').filter(div => div !== 'None')))];
  divisionButtons.innerHTML = '';
  const allDivisionButton = document.createElement('button');
  allDivisionButton.className = `filter-btn ${buttonDivision === 'ALL' ? 'active' : ''}`;
  allDivisionButton.textContent = `ALL (${allRemarksData.length})`;
  allDivisionButton.addEventListener('click', () => {
    buttonDivision = 'ALL';
    currentPage = 1;
    renderTables();
  });
  divisionButtons.appendChild(allDivisionButton);
  uniqueDivisions.forEach(div => {
    const count = divisionCounts[div] || 0;
    if (count > 0) {
      const button = document.createElement('button');
      button.className = `filter-btn ${div === buttonDivision ? 'active' : ''}`;
      button.textContent = `${div} (${count})`;
      button.addEventListener('click', () => {
        buttonDivision = div;
        currentPage = 1;
        renderTables();
      });
      divisionButtons.appendChild(button);
    }
  });

  const categoryButtons = document.getElementById('categoryButtons');
  categoryButtons.innerHTML = '';
  const allCategoryButton = document.createElement('button');
  allCategoryButton.className = `filter-btn ${buttonCategory === 'ALL' ? 'active' : ''}`;
  allCategoryButton.textContent = `ALL (${allRemarksData.length})`;
  allCategoryButton.addEventListener('click', () => {
    buttonCategory = 'ALL';
    currentPage = 1;
    renderTables();
  });
  categoryButtons.appendChild(allCategoryButton);
  categories.forEach(cat => {
    const count = categoryCounts[cat.name] || 0;
    if (count > 0) {
      const button = document.createElement('button');
      button.className = `filter-btn ${cat.name === buttonCategory ? 'active' : ''} ${cat.class}`;
      button.textContent = `${cat.name} (${count})`;
      button.addEventListener('click', () => {
        buttonCategory = cat.name;
        currentPage = 1;
        renderTables();
      });
      categoryButtons.appendChild(button);
    }
  });

  const remarksHeader = document.getElementById('remarksHeader');
  const remarksBody = document.getElementById('remarksBody');
  const excelRemarksData = [];

  remarksHeader.innerHTML = `
    <th>Date</th>
    <th>Division</th>
    <th>Category</th>
    <th>Remark</th>
  `;

  remarksData = [];
  const divisionsToShow = buttonDivision === 'ALL' ? uniqueDivisions : [buttonDivision];

  divisionsToShow.forEach(division => {
    const filteredData = allRemarksData.filter(row => row.division === division && (buttonCategory === 'ALL' || row.categories.some(c => c.name === buttonCategory)));
    if (filteredData.length > 0) {
      if (buttonDivision === 'ALL') {
        remarksData.push({ isHeader: true, division });
      }
      remarksData.push(...filteredData);
    }
  });

  remarksBody.innerHTML = '';
  if (remarksData.length === 0) {
    remarksBody.innerHTML = `<tr><td colspan="4">No remarks data available for the selected filters.</td></tr>`;
  } else {
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedData = remarksData.slice(start, end);
    paginatedData.forEach(row => {
      if (row.isHeader) {
        const html = `<tr><td colspan="4" class="division-group-header">${row.division}</td></tr>`;
        remarksBody.insertAdjacentHTML('beforeend', html);
      } else {
        row.categories.forEach(c => {
          if (buttonCategory === 'ALL' || c.name === buttonCategory) {
            const cat = categories.find(cat => cat.name === c.name);
            const html = `
              <tr>
                <td>${row.date}</td>
                <td>${row.division}</td>
                <td class="${cat.class}">${c.name}</td>
                <td class="${cat.class}">${c.remark}</td>
              </tr>
            `;
            remarksBody.insertAdjacentHTML('beforeend', html);
          }
        });
      }
    });

    // Populate excelRemarksData
    allRemarksData.forEach(row => {
      row.categories.forEach(c => {
        if (buttonCategory === 'ALL' || c.name === buttonCategory) {
          if (buttonDivision === 'ALL' || row.division === buttonDivision) {
            excelRemarksData.push({
              Date: row.date,
              Division: row.division,
              Category: c.name,
              Remark: c.remark
            });
          }
        }
      });
    });
  }

  const totalPages = Math.ceil(remarksData.length / rowsPerPage);
  document.getElementById('pageInfo').textContent = remarksData.length > 0 ? `Page ${currentPage} of ${totalPages}` : '';
  document.getElementById('prevPageBtn').classList.toggle('disabled', currentPage === 1);
  document.getElementById('nextPageBtn').classList.toggle('disabled', currentPage === totalPages || totalPages === 0);

  document.getElementById('excelBtn').dataset.excelSummaryData = JSON.stringify(excelSummaryData);
  document.getElementById('excelBtn').dataset.excelDivisionSummaryData = JSON.stringify(excelDivisionSummaryData);
  document.getElementById('excelBtn').dataset.excelRemarksData = JSON.stringify(excelRemarksData);
}

function sortTable(column) {
  summaryData.sort((a, b) => {
    if (column === 'sn' || column === 'checks' || column === 'deficiencies') {
      return a[column] - b[column];
    }
    return a[column].localeCompare(b[column]);
  });
  renderTables();
}

function sortDivisionTable(column) {
  const divisions = Object.keys(divisionSummaryData);
  divisions.sort((a, b) => {
    if (column === 'division') return a.localeCompare(b);
    return divisionSummaryData[b][column] - divisionSummaryData[a][column];
  });
  renderTables();
}

function exportToExcel() {
  try {
    const excelSummaryData = JSON.parse(document.getElementById('excelBtn').dataset.excelSummaryData || '[]');
    const excelDivisionSummaryData = JSON.parse(document.getElementById('excelBtn').dataset.excelDivisionSummaryData || '[]');
    const excelRemarksData = JSON.parse(document.getElementById('excelBtn').dataset.excelRemarksData || '[]');
    if (excelSummaryData.length === 0 && excelDivisionSummaryData.length === 0 && excelRemarksData.length === 0) {
      alert('No data available to export to Excel.');
      return;
    }
    const wb = XLSX.utils.book_new();
    if (excelSummaryData.length > 0) {
      const wsSummary = XLSX.utils.json_to_sheet(excelSummaryData);
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Category Summary');
    }
    if (excelDivisionSummaryData.length > 0) {
      const wsDivisionSummary = XLSX.utils.json_to_sheet(excelDivisionSummaryData);
      XLSX.utils.book_append_sheet(wb, wsDivisionSummary, 'Division Summary');
    }
    if (excelRemarksData.length > 0) {
      const wsRemarks = XLSX.utils.json_to_sheet(excelRemarksData);
      XLSX.utils.book_append_sheet(wb, wsRemarks, 'Remarks');
    }
    const today = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `Crew_Summary_Remarks_${today}.xlsx`);
  } catch (err) {
    console.error('Excel Export Error:', err);
    alert('Failed to export Excel. Please check the console for details or try again.');
  }
}

async function showPdfPreview() {
  try {
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = '';

    const pageWidth = 297; // A4 landscape width in mm
    const pageHeight = 210; // A4 landscape height in mm
    const margin = pdfSettings.margin;
    const contentWidth = pageWidth - 2 * margin;
    const contentHeight = pageHeight - 2 * margin;
    const lineHeight = pdfSettings.fontSize * 0.3528 * 1.2;

    const header = document.querySelector('.header-buttons');
    const topBar = document.querySelector('.top-bar');
    const canvas = await html2canvas(document.body, {
      scale: 0.5,
      useCORS: true,
      dpi: 72,
      letterRendering: true,
      scrollX: 0,
      scrollY: 0,
      width: header.offsetWidth,
      height: header.offsetHeight + topBar.offsetHeight + 15
    });
    const imgWidth = contentWidth / 2;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let yOffset = margin + 10;
    let pageCount = 1;
    let content = [];

    const headerHeight = imgHeight * 2.835;
    content.push(`<strong>Header & Top Bar</strong> (${headerHeight.toFixed(1)}mm)<br><img src="${canvas.toDataURL('image/jpeg', 0.5)}" style="width:${imgWidth}px; height:${imgHeight}px;">`);
    yOffset += headerHeight;

    const summaryRows = summaryData.length + 1;
    const summaryHeight = summaryRows * lineHeight;
    if (yOffset + summaryHeight > contentHeight) {
      pageCount++;
      content.push('--- Page Break ---');
      yOffset = margin;
    }
    content.push(`<strong>Category Summary Table</strong> (${summaryRows} rows, ${summaryHeight.toFixed(1)}mm)`);
    yOffset += summaryHeight + 5;

    if (showDivisionSummary) {
      const divisionRows = Object.keys(divisionSummaryData).length + 1;
      const divisionHeight = divisionRows * lineHeight;
      if (yOffset + divisionHeight > contentHeight) {
        pageCount++;
        content.push('--- Page Break ---');
        yOffset = margin;
      }
      content.push(`<strong>Division Summary Table</strong> (${divisionRows} rows, ${divisionHeight.toFixed(1)}mm)`);
      yOffset += divisionHeight + 5;
    }

    const remarksRows = remarksData.reduce((sum, r) => sum + (r.isHeader ? 1 : r.categories.length), 0);
    const remarksHeight = remarksRows * lineHeight;
    if (yOffset + remarksHeight > contentHeight) {
      pageCount += Math.ceil((yOffset + remarksHeight - contentHeight) / contentHeight);
      content.push('--- Page Break ---');
    }
    content.push(`<strong>Remarks Table</strong> (${remarksRows} rows, ${remarksHeight.toFixed(1)}mm)`);

    const pagination = document.querySelector('.pagination');
    const paginationCanvas = await html2canvas(pagination, {
      scale: 0.5,
      useCORS: true,
      dpi: 72,
      letterRendering: true
    });
    const paginationImgWidth = contentWidth / 2;
    const paginationImgHeight = (paginationCanvas.height * paginationImgWidth) / paginationCanvas.width;
    content.push(`<strong>Pagination Controls</strong> <br><img src="${paginationCanvas.toDataURL('image/jpeg', 0.5)}" style="width:${paginationImgWidth}px; height:${paginationImgHeight}px;">`);

    let currentPage = 1;
    let pageContent = [];
    content.forEach(item => {
      if (item === '--- Page Break ---') {
        previewContent.insertAdjacentHTML('beforeend', `<div class="preview-page"><strong>Page ${currentPage}</strong><br>${pageContent.join('<br>')}</div>`);
        currentPage++;
        pageContent = [];
      } else {
        pageContent.push(item);
      }
    });
    if (pageContent.length > 0) {
      previewContent.insertAdjacentHTML('beforeend', `<div class="preview-page"><strong>Page ${currentPage}</strong><br>${pageContent.join('<br>')}</div>`);
    }

    const estimatedSize = (summaryRows + (showDivisionSummary ? Object.keys(divisionSummaryData).length : 0) + remarksRows) * 0.03 + 1.0;
    previewContent.insertAdjacentHTML('beforeend', `<p>Estimated File Size: ${estimatedSize.toFixed(1)} MB</p>`);

    document.getElementById('pdfPreviewModal').style.display = 'flex';
  } catch (err) {
    console.error('PDF Preview Error:', err);
    alert('Failed to generate PDF preview. Please check the console for details or try again.');
  }
}

async function exportToPDF() {
  try {
    document.getElementById('pdfPreviewModal').style.display = 'none';
    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = pdfSettings.margin;
    const contentWidth = pageWidth - 2 * margin;

    if (!summaryData.length && !remarksData.length) {
      alert('No data available to export to PDF.');
      return;
    }

    // Header image
    const header = document.querySelector('.header-buttons');
    const topBar = document.querySelector('.top-bar');
    const canvas = await html2canvas(document.body, {
      scale: 1.0,
      useCORS: true,
      dpi: 96,
      letterRendering: true,
      scrollX: 0,
      scrollY: 0,
      width: header.offsetWidth,
      height: header.offsetHeight + topBar.offsetHeight + 15
    });
    const imgWidth = contentWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    const quality = 0.7;
    doc.addImage(canvas.toDataURL('image/jpeg', quality), 'JPEG', margin, margin, imgWidth, imgHeight);

    let yOffset = margin + imgHeight + 5;

    doc.setFont('Roboto', 'normal');
    doc.setFontSize(pdfSettings.fontSize);
    doc.text('Category Summary', pageWidth / 2, yOffset, { align: 'center' });
    yOffset += 4;
    doc.autoTable({
      startY: yOffset,
      head: [['SN', 'Category', 'No of Checks Conducted', 'Deficiencies Noticed', 'Divisions Deficiencies']],
      body: summaryData.map(row => [row.sn, row.category, row.checks, row.deficiencies, row.divisionsWithDef]),
      theme: 'grid',
      styles: {
        font: 'Roboto',
        fontSize: pdfSettings.fontSize,
        textColor: [26, 26, 26],
        lineColor: [224, 230, 239],
        lineWidth: 0.2,
        cellPadding: 0.5,
        overflow: 'linebreak',
        minCellHeight: pdfSettings.fontSize * 0.3528 * 1.2,
        rowPageBreak: 'avoid'
      },
      headStyles: {
        fillColor: [0, 116, 217],
        textColor: [255, 255, 255]
      },
      alternateRowStyles: {
        fillColor: [248, 250, 252]
      },
      columnStyles: {
        0: { cellWidth: 'auto' },
        1: { cellWidth: 'auto' },
        2: { cellWidth: 'auto' },
        3: { cellWidth: 'auto' },
        4: { cellWidth: 'auto' }
      },
      didParseCell: (data) => {
        if (data.section === 'body') {
          data.cell.styles.cellWidth = Math.max(60 / 2.835 * pdfSettings.columnWidthMultiplier, data.cell.raw.toString().length * pdfSettings.fontSize * 0.1);
        }
      },
      margin: { top: margin, left: margin, right: margin }
    });
    yOffset = doc.lastAutoTable.finalY + 5;

    if (showDivisionSummary) {
      doc.text('Division-Based Summary', pageWidth / 2, yOffset, { align: 'center' });
      yOffset += 4;
      doc.autoTable({
        startY: yOffset,
        head: [['Division', ...categories.flatMap(cat => [cat.name + ' Checks', cat.name + ' Def.'])]],
        body: Object.keys(divisionSummaryData).map(division => {
          const g = divisionSummaryData[division];
          return [division, ...categories.flatMap(cat => [g[cat.name + 'Check'], g[cat.name + 'Def']])];
        }),
        theme: 'grid',
        styles: {
          font: 'Roboto',
          fontSize: pdfSettings.fontSize,
          textColor: [26, 26, 26],
          lineColor: [224, 230, 239],
          lineWidth: 0.2,
          cellPadding: 0.5,
          overflow: 'linebreak',
          minCellHeight: pdfSettings.fontSize * 0.3528 * 1.2,
          rowPageBreak: 'avoid'
        },
        headStyles: {
          fillColor: [0, 116, 217],
          textColor: [255, 255, 255]
        },
        alternateRowStyles: {
          fillColor: [248, 250, 252]
        },
        columnStyles: Object.fromEntries(Array(categories.length * 2 + 1).fill().map((_, i) => [i, { cellWidth: 'auto' }])),
        didParseCell: (data) => {
          if (data.section === 'body') {
            data.cell.styles.cellWidth = Math.max(60 / 2.835 * pdfSettings.columnWidthMultiplier, data.cell.raw.toString().length * pdfSettings.fontSize * 0.1);
          }
        },
        margin: { top: margin, left: margin, right: margin }
      });
      yOffset = doc.lastAutoTable.finalY + 5;
    }

    doc.text('Remarks Details', pageWidth / 2, yOffset, { align: 'center' });
    yOffset += 4;
    const remarksTableData = [];
    remarksData.forEach(row => {
      if (row.isHeader) {
        remarksTableData.push([{ content: row.division, colSpan: 4, styles: { fillColor: [224, 230, 239], textColor: [26, 26, 26], fontStyle: 'bold', halign: 'left' } }]);
      } else {
        row.categories.forEach(c => {
          const cat = categories.find(cat => cat.name === c.name);
          const fillColor = {
            'cat-spm': [230, 243, 255],
            'cat-cvvrs': [230, 255, 230],
            'cat-mobile': [255, 245, 230],
            'cat-ambush-dfc': [255, 230, 230],
            'cat-alprs': [230, 230, 255],
            'cat-memu': [240, 230, 255],
            'cat-ibh': [255, 255, 230],
            'cat-runningroom': [230, 255, 240],
            'cat-stabling': [255, 230, 240],
            'cat-shunting': [230, 250, 255]
          }[cat.class] || [255, 255, 255];
          remarksTableData.push([
            { content: row.date },
            { content: row.division },
            { content: c.name, styles: { fillColor } },
            { content: c.remark, styles: { fillColor } }
          ]);
        });
      }
    });
    doc.autoTable({
      startY: yOffset,
      head: [['Date', 'Division', 'Category', 'Remark']],
      body: remarksTableData,
      theme: 'grid',
      styles: {
        font: 'Roboto',
        fontSize: pdfSettings.fontSize,
        textColor: [26, 26, 26],
        lineColor: [224, 230, 239],
        lineWidth: 0.2,
        cellPadding: 0.5,
        overflow: 'linebreak',
        minCellHeight: pdfSettings.fontSize * 0.3528 * 1.2,
        rowPageBreak: 'avoid'
      },
      headStyles: {
        fillColor: [0, 116, 217],
        textColor: [255, 255, 255]
      },
      alternateRowStyles: {
        fillColor: [248, 250, 252]
      },
      columnStyles: {
        0: { cellWidth: 'auto' },
        1: { cellWidth: 'auto' },
        2: { cellWidth: 'auto' },
        3: { cellWidth: 'auto' }
      },
      didParseCell: (data) => {
        if (data.section === 'body' && !data.row.cells[0].styles.fillColor) {
          data.cell.styles.cellWidth = Math.max(60 / 2.835 * pdfSettings.columnWidthMultiplier, data.cell.raw.toString().length * pdfSettings.fontSize * 0.1);
        }
      },
      margin: { top: margin, left: margin, right: margin }
    });
    yOffset = doc.lastAutoTable.finalY + 5;

    const pagination = document.querySelector('.pagination');
    const paginationCanvas = await html2canvas(pagination, {
      scale: 1.0,
      useCORS: true,
      dpi: 96,
      letterRendering: true
    });
    const paginationImgWidth = contentWidth;
    const paginationImgHeight = (paginationCanvas.height * paginationImgWidth) / paginationCanvas.width;
    if (yOffset + paginationImgHeight > pageHeight - margin) {
      doc.addPage();
      yOffset = margin;
    }
    doc.addImage(paginationCanvas.toDataURL('image/jpeg', quality), 'JPEG', margin, yOffset, paginationImgWidth, paginationImgHeight);

    const today = new Date().toISOString().split('T')[0];
    doc.save(`Crew_Summary_Remarks_${today}.pdf`);
  } catch (err) {
    console.error('PDF Export Error:', err);
    alert('Failed to export PDF. Please check the console for details or try again.');
  }
}
</script>
</body>
</html>
