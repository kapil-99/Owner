<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crew Performance Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      min-height: 100vh;
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      background: #f5f7fa;
      color: #1a1a1a;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    h2 {
      background: linear-gradient(90deg, #003366 50%, #0074D9 100%);
      color: #fff;
      padding: 14px 0;
      text-align: center;
      margin: 0 0 12px 0;
      font-size: 1.8rem;
      font-weight: 500;
      letter-spacing: 0.5px;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 51, 102, 0.2);
    }
    .top-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: flex-start;
      margin: 10px 0 0 10px;
      flex-wrap: wrap;
    }
    .date-picker {
      padding: 6px 8px;
      font-size: 0.95rem;
      border-radius: 5px;
      border: 1px solid #b0c4de;
      background: #f8fafc;
      color: #003366;
      outline: none;
      width: 200px;
    }
    .screenshot-btn, .analyze-btn, .excel-btn, .csv-btn, .reset-btn, .chart-export-btn {
      padding: 6px 12px;
      border-radius: 5px;
      border: 1px solid #0074D9;
      background: #0074D9;
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .screenshot-btn:hover, .analyze-btn:hover, .excel-btn:hover, .csv-btn:hover, .reset-btn:hover, .chart-export-btn:hover {
      background: #003366;
    }
    .metric-filter {
      padding: 6px 8px;
      font-size: 0.95rem;
      border-radius: 5px;
      border: 1px solid #b0c4de;
      background: #f8fafc;
      color: #003366;
      outline: none;
    }
    .chart-type-toggle {
      padding: 6px 12px;
      border-radius: 5px;
      border: 1px solid #0074D9;
      background: #fff;
      color: #0074D9;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .chart-type-toggle.active {
      background: #0074D9;
      color: #fff;
    }
    #divisionBtnBar {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 0 auto 12px;
      flex-wrap: wrap;
      max-width: 90%;
      padding: 0 10px;
    }
    .division-btn {
      padding: 5px 14px;
      font-size: 0.9rem;
      border-radius: 5px;
      border: 1px solid #0074D9;
      background: #fff;
      color: #0074D9;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .division-btn:hover {
      background: #0074D9;
      color: #fff;
      border-color: #003366;
      box-shadow: 0 2px 4px rgba(0, 51, 102, 0.2);
    }
    .division-btn.active {
      background: #0074D9;
      color: #fff;
      border-color: #003366;
    }
    .division-btn.all {
      border-color: #666;
      color: #666;
      background: #f5f7fa;
    }
    .division-btn.all.active, .division-btn.all:hover {
      background: #003366;
      color: #fff;
      border-color: #003366;
    }
    .charts-grid, .ambush-sub-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      max-width: 98%;
      margin: 0 auto 16px;
      padding: 0 8px;
    }
    .chart-container {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 51, 102, 0.1);
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-height: 280px;
      height: 100%;
      position: relative;
    }
    .chart-container h4 {
      text-align: center;
      margin: 0 0 8px;
      color: #003366;
      font-size: 1rem;
      font-weight: 500;
    }
    .chart-container canvas {
      width: 100% !important;
      height: calc(25vh - 24px) !important;
      max-height: 240px;
    }
    .trend-summary {
      margin: 12px auto;
      padding: 10px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e0e6ef;
      max-width: 98%;
      text-align: center;
    }
    .trend-summary h4 {
      margin: 0 0 8px;
      color: #003366;
      font-size: 1.2rem;
    }
    .trend-summary p {
      margin: 5px 0;
      font-size: 0.9rem;
    }
    table {
      margin: 0 auto 24px;
      border-collapse: collapse;
      width: 98%;
      max-width: 98%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 51, 102, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    table th, table td {
      border: 1px solid #e0e6ef;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    table th {
      background: #0074D9;
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
    }
    table th:hover {
      background: #003366;
    }
    table tr:nth-child(even) td {
      background: #f8fafc;
    }
    table tr:hover td {
      background: #e6f0fa;
    }
    .highlight-deficiency {
      background: #ffcccc !important;
    }
    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }
    .popup-content {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 98%;
      margin: 20px auto;
      position: relative;
      overflow-x: auto;
    }
    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .popup-header h3 {
      margin: 0;
      color: #003366;
      font-size: 1.5rem;
    }
    .popup-header .button-group {
      display: flex;
      gap: 8px;
    }
    .close-btn {
      padding: 8px 16px;
      border: none;
      background: #ff4d4d;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    }
    .close-btn:hover {
      background: #cc0000;
    }
    .analysis-table, .ambush-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      table-layout: auto;
    }
    .analysis-table th, .analysis-table td, .ambush-table th, .ambush-table td {
      border: 1px solid #e0e6ef;
      padding: 10px;
      text-align: center;
      font-size: 0.9rem;
      min-width: 80px;
    }
    .analysis-table th, .ambush-table th {
      background: #0074D9;
      color: #fff;
      font-weight: 600;
    }
    .analysis-table tr:nth-child(even) td, .ambush-table tr:nth-child(even) td {
      background: #f8fafc;
    }
    .analysis-table tr:hover td, .ambush-table tr:hover td {
      background: #e6f0fa;
    }
    .insights {
      margin-top: 20px;
      padding: 10px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e0e6ef;
    }
    .insights h4 {
      margin: 0 0 10px;
      color: #003366;
      font-size: 1.2rem;
    }
    .insights p {
      margin: 5px 0;
      font-size: 0.9rem;
    }
    .screenshot-header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: #003366;
      color: #fff;
      padding: 10px;
      text-align: center;
      font-size: 1rem;
      z-index: 1001;
    }
    .hidden { display: none; }
    @media (max-width: 1200px) {
      .charts-grid, .ambush-sub-charts {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }
    @media (max-width: 768px) {
      .charts-grid, .ambush-sub-charts {
        grid-template-columns: 1fr;
      }
      .chart-container {
        min-height: 200px;
      }
      .chart-container canvas {
        height: calc(20vh - 16px) !important;
        max-height: 200px;
      }
      h2 {
        font-size: 1.5rem;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .search-bar, .date-picker, .metric-filter {
        width: 100%;
      }
      .popup-content {
        padding: 10px;
      }
      .analysis-table th, .analysis-table td, .ambush-table th, .ambush-table td {
        font-size: 0.8rem;
        padding: 6px;
        min-width: 60px;
      }
    }
    @media (max-width: 480px) {
      h2 {
        font-size: 1.2rem;
      }
      .search-bar, .date-picker, .metric-filter, .division-btn, .analyze-btn, .screenshot-btn, .excel-btn, .csv-btn, .reset-btn, .chart-export-btn {
        font-size: 0.8rem;
      }
      .popup-header h3 {
        font-size: 1.2rem;
      }
      .analysis-table th, .analysis-table td, .ambush-table th, .ambush-table td {
        font-size: 0.7rem;
        padding: 4px;
      }
    }
  </style>
</head>
<body>
<div class="top-bar">
  <input type="text" id="datePicker" class="date-picker" placeholder="Select Date Range">
  <select id="metricFilter" class="metric-filter">
    <option value="all">All Metrics</option>
    <option value="spm">SPM</option>
    <option value="cvvrs">CVVRS</option>
    <option value="mobile">Mobile</option>
    <option value="ambush">Ambush</option>
  </select>
  <button class="reset-btn" id="resetBtn">ðŸ”„ Reset Filters</button>
  <button class="screenshot-btn" id="screenshotBtn">ðŸ“¸ Screenshot</button>
  <button class="analyze-btn" id="analyzeBtn">ðŸ“Š Analyze Data</button>
  <button class="excel-btn" id="deficiencyToggleBtn" style="background:#ff4d4d;border-color:#ff4d4d;">Deficiencies</button>
  <div>
    <button class="chart-type-toggle" id="barToggle" data-type="bar">Bar</button>
    <button class="chart-type-toggle" id="lineToggle" data-type="line">Line</button>
  </div>
</div>

<h2>ðŸš¦ Crew Performance Dashboard</h2>

<div class="trend-summary" id="trendSummary"></div>

<div id="divisionBtnBar"></div>

<div class="charts-grid">
  <div class="chart-container" id="spmChartContainer">
    <h4>SPM Performance</h4>
    <canvas id="spmChart"></canvas>
    <button class="chart-export-btn" data-chart="spmChart"> </button>
  </div>
  <div class="chart-container" id="cvvrsChartContainer">
    <h4>CVVRS Performance</h4>
    <canvas id="cvvrsChart"></canvas>
    <button class="chart-export-btn" data-chart="cvvrsChart"> </button>
  </div>
  <div class="chart-container" id="mobileChartContainer">
    <h4>Mobile Performance</h4>
    <canvas id="mobileChart"></canvas>
    <button class="chart-export-btn" data-chart="mobileChart"> </button>
  </div>
  <div class="chart-container" id="ambushChartContainer">
    <h4>Ambush Performance</h4>
    <canvas id="ambushChart"></canvas>
    <button class="chart-export-btn" data-chart="ambushChart"> </button>
  </div>
</div>

<div class="ambush-sub-charts">
  <div class="chart-container" id="ambush1ChartContainer">
    <h4>Yellow Signal DFC</h4>
    <canvas id="ambush1Chart"></canvas>
    <button class="chart-export-btn" data-chart="ambush1Chart"> </button>
  </div>
  <div class="chart-container" id="ambush2ChartContainer">
    <h4>Yellow Signal IR</h4>
    <canvas id="ambush2Chart"></canvas>
    <button class="chart-export-btn" data-chart="ambush2Chart"> </button>
  </div>
  <div class="chart-container" id="ambush3ChartContainer">
    <h4>ALP holding RS valve</h4>
    <canvas id="ambush3Chart"></canvas>
    <button class="chart-export-btn" data-chart="ambush3Chart"> </button>
  </div>
  <div class="chart-container" id="ambush4ChartContainer">
    <h4>MEMUs/EMUs Speed checked at PF</h4>
    <canvas id="ambush4Chart"></canvas>
    <button class="chart-export-btn" data-chart="ambush4Chart"> </button>
  </div>
  <div class="chart-container" id="ambush5ChartContainer">
    <h4>IBH Signal Passed as per Rule</h4>
    <canvas id="ambush5Chart"></canvas>
    <button class="chart-export-btn" data-chart="ambush5Chart"> </button>
  </div>
  <div class="chart-container" id="ambush6ChartContainer">
    <h4>Running room wee Hours</h4>
    <canvas id="ambush6Chart"></canvas>
    <button class="chart-export-btn" data-chart="ambush6Chart"> </button>
  </div>
  <div class="chart-container" id="ambush7ChartContainer">
    <h4>Stabling/Securing of Loads</h4>
    <canvas id="ambush7Chart"></canvas>
    <button class="chart-export-btn" data-chart="ambush7Chart"> </button>
  </div>
  <div class="chart-container" id="ambush8ChartContainer">
    <h4>Shunting operations Checked</h4>
    <canvas id="ambush8Chart"></canvas>
    <button class="chart-export-btn" data-chart="ambush8Chart"> </button>
  </div>
</div>

<table id="summaryTable">
  <thead>
    <tr id="summaryHeader"></tr>
  </thead>
  <tbody></tbody>
</table>

<div class="popup" id="analysisPopup">
  <div class="popup-content">
    <div class="popup-header">
      <h3>Data Analysis</h3>
      <div class="button-group">
        <button class="excel-btn" id="excelExportBtn">ðŸ“¥ Export to Excel</button>
        <button class="screenshot-btn" id="popupScreenshotBtn">ðŸ“¸ Screenshot</button>
        <button class="close-btn" id="closePopupBtn">Close</button>
      </div>
    </div>
    <h4>Main Metrics</h4>
    <table class="analysis-table" id="analysisTable">
      <thead>
        <tr id="analysisHeader"></tr>
      </thead>
      <tbody id="analysisBody"></tbody>
    </table>
    <div class="insights" id="insights"></div>
    <h4>Ambush Performance Details</h4>
    <table class="ambush-table" id="ambushTable">
      <thead>
        <tr id="ambushHeader"></tr>
      </thead>
      <tbody id="ambushBody"></tbody>
    </table>
  </div>
</div>

<!-- Add deficiency details popup -->
<div class="popup" id="deficiencyPopup">
  <div class="popup-content">
    <div class="popup-header">
      <h3>Deficiency Details</h3>
      <button class="close-btn" id="closeDefPopupBtn">Close</button>
    </div>
    <div id="deficiencyDetails"></div>
  </div>
</div>

<script>
const SHEET_ID = '12mtmU8RBHFLUpFXYCdGH96mMBL_Ec6cpvh0dR_CotZg';
const API_KEY = 'AIzaSyBkKVtdfFbFfdFE8FqSaUGZvptxj0Fysco';
const RANGE = 'CrewData!A1:AG1000';
let allData = [], headers = [], charts = [], grouped = {}, deficiencyMap = {};
let selectedDivision = 'ALL', chartType = 'bar';
let fromDate = '', toDate = '';
let showOnlyDeficiency = false;

fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`)
  .then(res => {
    if (!res.ok) throw new Error('Failed to fetch data from Google Sheets');
    return res.json();
  })
  .then(data => {
    allData = data.values;
    headers = allData[0];
    initUI();
    renderDivisionButtons();
    renderAllCharts();
  })
  .catch(err => {
    console.error(err);
    alert('Error fetching data. Please check your internet connection or try again later.');
  });

function initUI() {
  const today = new Date();
  const defaultFrom = new Date();
  defaultFrom.setDate(today.getDate() - 6);
  fromDate = defaultFrom.toISOString().split('T')[0];
  toDate = today.toISOString().split('T')[0];

  flatpickr('#datePicker', {
    mode: 'range',
    dateFormat: 'Y-m-d',
    defaultDate: [fromDate, toDate],
    static: true,
    onChange: (selectedDates) => {
      if (selectedDates.length === 2) {
        fromDate = selectedDates[0].toISOString().split('T')[0];
        toDate = selectedDates[1].toISOString().split('T')[0];
        if (fromDate > toDate) {
          alert('Start date cannot be later than end date.');
          fromDate = toDate;
          document.getElementById('datePicker')._flatpickr.setDate([toDate, toDate]);
        }
        renderDivisionButtons();
        renderAllCharts();
      }
    }
  });

  document.getElementById('metricFilter').addEventListener('change', function() {
    const value = this.value;
    document.querySelectorAll('.chart-container').forEach(container => {
      container.style.display = (value === 'all' || container.id.toLowerCase().includes(value)) ? 'flex' : 'none';
    });
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    selectedDivision = 'ALL';
    document.getElementById('metricFilter').value = 'all';
    const today = new Date();
    const defaultFrom = new Date();
    defaultFrom.setDate(today.getDate() - 6);
    fromDate = defaultFrom.toISOString().split('T')[0];
    toDate = today.toISOString().split('T')[0];
    document.getElementById('datePicker')._flatpickr.setDate([fromDate, toDate]);
    document.querySelectorAll('.chart-container').forEach(container => {
      container.style.display = 'flex';
    });
    renderDivisionButtons();
    renderAllCharts();
  });

  document.getElementById('screenshotBtn').addEventListener('click', () => {
    const mainContent = document.body;
    addScreenshotHeader(mainContent, 'Dashboard');
    setTimeout(() => {
      html2canvas(mainContent, { scale: 2, ignoreElements: el => el.classList && el.classList.contains('popup') && el.style.display !== 'none' }).then(canvas => {
        const link = document.createElement('a');
        link.download = `dashboard_screenshot_${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        removeScreenshotHeader();
      });
    }, 100); // Wait for header to render
  });

  document.getElementById('popupScreenshotBtn').addEventListener('click', () => {
    const popupContent = document.querySelector('#analysisPopup .popup-content');
    addScreenshotHeader(popupContent, 'Analysis');
    setTimeout(() => {
      html2canvas(popupContent, { scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `analysis_screenshot_${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        removeScreenshotHeader();
      });
    }, 100);
  });

  document.getElementById('deficiencyPopup').addEventListener('click', function(e) {
    if (e.target && e.target.id === 'defScreenshotBtn') {
      const popupContent = document.querySelector('#deficiencyPopup .popup-content');
      addScreenshotHeader(popupContent, 'Deficiency');
      setTimeout(() => {
        html2canvas(popupContent, { scale: 2 }).then(canvas => {
          const link = document.createElement('a');
          link.download = `deficiency_screenshot_${new Date().toISOString().split('T')[0]}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
          removeScreenshotHeader();
        });
      }, 100);
    }
  });

  document.getElementById('analyzeBtn').addEventListener('click', () => {
    if (Object.keys(grouped).length === 0) {
      alert('Data is still loading. Please try again in a moment.');
      return;
    }
    document.getElementById('analysisPopup').style.display = 'block';
    renderAnalysisTable();
  });

  document.getElementById('closePopupBtn').addEventListener('click', () => {
    document.getElementById('analysisPopup').style.display = 'none';
  });

  document.getElementById('closeDefPopupBtn').onclick = function() {
    document.getElementById('deficiencyPopup').style.display = 'none';
  }

  document.getElementById('excelExportBtn').addEventListener('click', exportToExcel);

  document.querySelectorAll('.chart-type-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      chartType = btn.dataset.type;
      document.querySelectorAll('.chart-type-toggle').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderAllCharts();
    });
  });
  document.getElementById('barToggle').classList.add('active');

  document.querySelectorAll('.chart-export-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const chartId = btn.dataset.chart;
      const canvas = document.getElementById(chartId);
      const link = document.createElement('a');
      link.download = `${chartId}_${new Date().toISOString().split('T')[0]}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  });

  document.getElementById('deficiencyToggleBtn').addEventListener('click', function() {
    showOnlyDeficiency = !showOnlyDeficiency;
    this.textContent = showOnlyDeficiency ? 'Show All' : 'Deficiencies';
    this.style.background = showOnlyDeficiency ? '#0074D9' : '#ff4d4d';
    this.style.borderColor = showOnlyDeficiency ? '#0074D9' : '#ff4d4d';
    renderAllCharts();
  });
}

function addScreenshotHeader(element, type) {
  // Remove any previous screenshot header
  removeScreenshotHeader();
  const header = document.createElement('div');
  header.className = 'screenshot-header';
  header.innerHTML = `
    Crew Performance ${type} - Date: ${new Date().toLocaleDateString()} | 
    Division: ${selectedDivision} | 
    Date Range: ${fromDate} to ${toDate}
  `;
  element.prepend(header);
}

function removeScreenshotHeader() {
  const header = document.querySelector('.screenshot-header');
  if (header) header.remove();
}

// Screenshot for dashboard (only main content, not overlays)
document.getElementById('screenshotBtn').addEventListener('click', () => {
  const mainContent = document.body;
  addScreenshotHeader(mainContent, 'Dashboard');
  setTimeout(() => {
    html2canvas(mainContent, { scale: 2, ignoreElements: el => el.classList && el.classList.contains('popup') && el.style.display !== 'none' }).then(canvas => {
      const link = document.createElement('a');
      link.download = `dashboard_screenshot_${new Date().toISOString().split('T')[0]}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      removeScreenshotHeader();
    });
  }, 100); // Wait for header to render
});

// Screenshot for popup (analysis)
document.getElementById('popupScreenshotBtn').addEventListener('click', () => {
  const popupContent = document.querySelector('#analysisPopup .popup-content');
  addScreenshotHeader(popupContent, 'Analysis');
  setTimeout(() => {
    html2canvas(popupContent, { scale: 2 }).then(canvas => {
      const link = document.createElement('a');
      link.download = `analysis_screenshot_${new Date().toISOString().split('T')[0]}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      removeScreenshotHeader();
    });
  }, 100);
});

// Screenshot for deficiency popup
document.getElementById('deficiencyPopup').addEventListener('click', function(e) {
  if (e.target && e.target.id === 'defScreenshotBtn') {
    const popupContent = document.querySelector('#deficiencyPopup .popup-content');
    addScreenshotHeader(popupContent, 'Deficiency');
    setTimeout(() => {
      html2canvas(popupContent, { scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `deficiency_screenshot_${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        removeScreenshotHeader();
      });
    }, 100);
  }
});

function renderDivisionButtons() {
  const idx = name => headers.indexOf(name);
  const divisions = [...new Set(allData.slice(2)
    .filter(r => r[idx('Date')] && r[idx('Date')] >= fromDate && r[idx('Date')] <= toDate)
    .map(r => r[1])
  )].filter(Boolean).sort();
  const bar = document.getElementById('divisionBtnBar');
  bar.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.textContent = 'All';
  allBtn.className = 'division-btn all' + (selectedDivision === 'ALL' ? ' active' : '');
  allBtn.onclick = () => {
    selectedDivision = 'ALL';
    renderAllCharts();
    renderDivisionButtons();
  };
  bar.appendChild(allBtn);
  divisions.forEach(d => {
    const btn = document.createElement('button');
    btn.textContent = d;
    btn.className = 'division-btn' + (selectedDivision === d ? ' active' : '');
    btn.onclick = () => {
      selectedDivision = d;
      renderAllCharts();
      renderDivisionButtons();
    };
    bar.appendChild(btn);
  });
}

function renderAllCharts() {
  const idx = name => headers.indexOf(name);
  grouped = {};
  deficiencyMap = {};

  const ambushIndices = [
    { nos: 15, def: 16, name: 'Yellow Signal DFC' },
    { nos: 17, def: 18, name: 'Yellow Signal IR' },
    { nos: 19, def: 20, name: 'ALP holding RS valve' },
    { nos: 21, def: 22, name: 'MEMUs/EMUs Speed checked at PF' },
    { nos: 23, def: 24, name: 'IBH Signal Passed as per Rule' },
    { nos: 25, def: 26, name: 'Running room wee Hours' },
    { nos: 27, def: 28, name: 'Stabling/Securing of Loads' },
    { nos: 29, def: 30, name: 'Shunting operations Checked' }
  ];

  if (selectedDivision === 'ALL') {
    allData.slice(2).forEach(r => {
      const date = r[idx('Date')], division = r[1];
      if (!division || !date || date < fromDate || date > toDate) return;
      if (!grouped[division]) {
        grouped[division] = {
          spm: 0, defSpm: 0, cvvrs: 0, defCvvrs: 0, mobile: 0, defMobile: 0, ambush: 0, defAmbush: 0
        };
        ambushIndices.forEach((_, i) => {
          grouped[division][`ambush${i+1}`] = 0;
          grouped[division][`defAmbush${i+1}`] = 0;
        });
      }

      grouped[division].spm += (+r[2] || 0);
      grouped[division].defSpm += (+r[3] || 0);
      grouped[division].cvvrs += (+r[4] || 0);
      grouped[division].defCvvrs += (+r[5] || 0);
      [6, 8, 10, 12, 13].forEach(i => grouped[division].mobile += (+r[i] || 0));
      [7, 9, 11, 14].forEach(i => grouped[division].defMobile += (+r[i] || 0));
      for (let i = 15; i <= 29; i += 2) {
        grouped[division].ambush += (+r[i] || 0);
        grouped[division].defAmbush += (+r[i+1] || 0);
      }
      ambushIndices.forEach((a, i) => {
        grouped[division][`ambush${i+1}`] += (+r[a.nos] || 0);
        grouped[division][`defAmbush${i+1}`] += (+r[a.def] || 0);
      });

      const key = `${division}`;
      deficiencyMap[key] = deficiencyMap[key] || [];
      deficiencyMap[key].push({
        date, division,
        remarks: r[idx("Deficiency / Remarks noticed during the day")] || '-',
        name: r[idx("Name with Designation")] || '-',
        spm: (+r[2] || 0),
        cvvrs: (+r[4] || 0),
        mobile: [6, 8, 10, 12, 13].reduce((sum, i) => sum + (+r[i] || 0), 0),
        ambush: (() => { let a = 0; for (let i = 15; i <= 29; i += 2) a += (+r[i] || 0); return a; })()
      });
    });

    const divisions = Object.keys(grouped).sort();
    renderSummaryTable(divisions, grouped, 'division');
    renderTrendSummary(divisions, grouped, 'division');
    renderChart("spmChart", "SPM", divisions.map(d => grouped[d].spm), divisions.map(d => grouped[d].defSpm), divisions);
    renderChart("cvvrsChart", "CVVRS", divisions.map(d => grouped[d].cvvrs), divisions.map(d => grouped[d].defCvvrs), divisions);
    renderChart("mobileChart", "Mobile", divisions.map(d => grouped[d].mobile), divisions.map(d => grouped[d].defMobile), divisions);
    renderChart("ambushChart", "Ambush", divisions.map(d => grouped[d].ambush), divisions.map(d => grouped[d].defAmbush), divisions);
    ambushIndices.forEach((a, i) => {
      renderChart(`ambush${i+1}Chart`, a.name, divisions.map(d => grouped[d][`ambush${i+1}`]), divisions.map(d => grouped[d][`defAmbush${i+1}`]), divisions);
    });

  } else {
    allData.slice(2).forEach(r => {
      const date = r[idx('Date')], division = r[1];
      if (!division || division !== selectedDivision || !date || date < fromDate || date > toDate) return;
      if (!grouped[date]) {
        grouped[date] = {
          spm: 0, defSpm: 0, cvvrs: 0, defCvvrs: 0, mobile: 0, defMobile: 0, ambush: 0, defAmbush: 0
        };
        ambushIndices.forEach((_, i) => {
          grouped[date][`ambush${i+1}`] = 0;
          grouped[date][`defAmbush${i+1}`] = 0;
        });
      }

      grouped[date].spm += (+r[2] || 0);
      grouped[date].defSpm += (+r[3] || 0);
      grouped[date].cvvrs += (+r[4] || 0);
      grouped[date].defCvvrs += (+r[5] || 0);
      [6, 8, 10, 12, 13].forEach(i => grouped[date].mobile += (+r[i] || 0));
      [7, 9, 11, 14].forEach(i => grouped[date].defMobile += (+r[i] || 0));
      for (let i = 15; i <= 29; i += 2) {
        grouped[date].ambush += (+r[i] || 0);
        grouped[date].defAmbush += (+r[i+1] || 0);
      }
      ambushIndices.forEach((a, i) => {
        grouped[date][`ambush${i+1}`] += (+r[a.nos] || 0);
        grouped[date][`defAmbush${i+1}`] += (+r[a.def] || 0);
      });

      const key = `${date}`;
      deficiencyMap[key] = deficiencyMap[key] || [];
      deficiencyMap[key].push({
        date, division,
        remarks: r[idx("Deficiency / Remarks noticed during the day")] || '-',
        name: r[idx("Name with Designation")] || '-',
        spm: (+r[2] || 0),
        cvvrs: (+r[4] || 0),
        mobile: [6, 8, 10, 12, 13].reduce((sum, i) => sum + (+r[i] || 0), 0),
        ambush: (() => { let a = 0; for (let i = 15; i <= 29; i += 2) a += (+r[i] || 0); return a; })()
      });
    });

    const dates = Object.keys(grouped).sort();
    renderSummaryTable(dates, grouped, 'date');
    renderTrendSummary(dates, grouped, 'date');
    renderChart("spmChart", "SPM", dates.map(d => grouped[d].spm), dates.map(d => grouped[d].defSpm), dates);
    renderChart("cvvrsChart", "CVVRS", dates.map(d => grouped[d].cvvrs), dates.map(d => grouped[d].defCvvrs), dates);
    renderChart("mobileChart", "Mobile", dates.map(d => grouped[d].mobile), dates.map(d => grouped[d].defMobile), dates);
    renderChart("ambushChart", "Ambush", dates.map(d => grouped[d].ambush), dates.map(d => grouped[d].defAmbush), dates);
    ambushIndices.forEach((a, i) => {
      renderChart(`ambush${i+1}Chart`, a.name, dates.map(d => grouped[d][`ambush${i+1}`]), dates.map(d => grouped[d][`defAmbush${i+1}`]), dates);
    });
  }
}

function renderSummaryTable(keys, grouped, mode) {
  const tbody = document.querySelector("#summaryTable tbody");
  const thead = document.getElementById("summaryHeader");
  tbody.innerHTML = "";
  if (mode === 'division') {
    thead.innerHTML = `
      <th></th>
      <th onclick="sortTable('division', 1)">Division</th>
      <th onclick="sortTable('spm', 2)">SPM</th>
      <th onclick="sortTable('defSpm', 3)">SPM Def</th>
      <th onclick="sortTable('cvvrs', 4)">CVVRS</th>
      <th onclick="sortTable('defCvvrs', 5)">CVVRS Def</th>
      <th onclick="sortTable('mobile', 6)">Mobile</th>
      <th onclick="sortTable('defMobile', 7)">Mobile Def</th>
      <th onclick="sortTable('ambush', 8)">Ambush</th>
      <th onclick="sortTable('defAmbush', 9)">Ambush Def</th>
    `;
  } else {
    thead.innerHTML = `
      <th onclick="sortTable('date', 0)">Date</th>
      <th onclick="sortTable('spm', 1)">SPM</th>
      <th onclick="sortTable('defSpm', 2)">SPM Def</th>
      <th onclick="sortTable('cvvrs', 3)">CVVRS</th>
      <th onclick="sortTable('defCvvrs', 4)">CVVRS Def</th>
      <th onclick="sortTable('mobile', 5)">Mobile</th>
      <th onclick="sortTable('defMobile', 6)">Mobile Def</th>
      <th onclick="sortTable('ambush', 7)">Ambush</th>
      <th onclick="sortTable('defAmbush', 8)">Ambush Def</th>
    `;
  }
  if (keys.length === 0) {
    tbody.innerHTML = `<tr><td colspan="${mode === 'division' ? 10 : 9}">No data available for the selected filters.</td></tr>`;
    return;
  }
  keys.forEach(key => {
    const g = grouped[key];
    let row = '';
    if (mode === 'division') {
      row = `
        <tr>
          <td>
            <button class="division-btn${selectedDivision===key?' active':''}" onclick="selectDivisionRow('${key}')">ðŸ”Ž</button>
          </td>
          <td>${key}</td>
          <td>${g.spm}</td>
          <td>${g.defSpm}</td>
          <td>${g.cvvrs}</td>
          <td>${g.defCvvrs}</td>
          <td>${g.mobile}</td>
          <td>${g.defMobile}</td>
          <td>${g.ambush}</td>
          <td>${g.defAmbush}</td>
        </tr>
      `;
    } else {
      row = `
        <tr>
          <td>${key}</td>
          <td>${g.spm}</td>
          <td>${g.defSpm}</td>
          <td>${g.cvvrs}</td>
          <td>${g.defCvvrs}</td>
          <td>${g.mobile}</td>
          <td>${g.defMobile}</td>
          <td>${g.ambush}</td>
          <td>${g.defAmbush}</td>
        </tr>
      `;
    }
    tbody.insertAdjacentHTML("beforeend", row);
  });
  // Add totals row
  if (keys.length > 0) {
    let total = {spm:0,defSpm:0,cvvrs:0,defCvvrs:0,mobile:0,defMobile:0,ambush:0,defAmbush:0};
    keys.forEach(key=>{
      const g=grouped[key];
      total.spm+=g.spm; total.defSpm+=g.defSpm;
      total.cvvrs+=g.cvvrs; total.defCvvrs+=g.defCvvrs;
      total.mobile+=g.mobile; total.defMobile+=g.defMobile;
      total.ambush+=g.ambush; total.defAmbush+=g.defAmbush;
    });
    let row = '';
    if (mode === 'division') {
      row = `
        <tr style="font-weight:bold;background:#e6f0fa;">
          <td></td>
          <td>Total</td>
          <td>${total.spm}</td>
          <td>${total.defSpm}</td>
          <td>${total.cvvrs}</td>
          <td>${total.defCvvrs}</td>
          <td>${total.mobile}</td>
          <td>${total.defMobile}</td>
          <td>${total.ambush}</td>
          <td>${total.defAmbush}</td>
        </tr>
      `;
    } else {
      row = `
        <tr style="font-weight:bold;background:#e6f0fa;">
          <td>Total</td>
          <td>${total.spm}</td>
          <td>${total.defSpm}</td>
          <td>${total.cvvrs}</td>
          <td>${total.defCvvrs}</td>
          <td>${total.mobile}</td>
          <td>${total.defMobile}</td>
          <td>${total.ambush}</td>
          <td>${total.defAmbush}</td>
        </tr>
      `;
    }
    tbody.insertAdjacentHTML("beforeend", row);
  }
}

function sortTable(column, index) {
  const mode = selectedDivision === 'ALL' ? 'division' : 'date';
  const keys = Object.keys(grouped);
  keys.sort((a, b) => {
    if (column === 'division' || column === 'date') {
      return a.localeCompare(b);
    }
    return grouped[b][column] - grouped[a][column];
  });
  renderSummaryTable(keys, grouped, mode);
  renderAnalysisTable();
}

function renderTrendSummary(keys, grouped, mode) {
  const trends = [];
  if (mode === 'date' && keys.length > 1) {
    const spmDiff = grouped[keys[keys.length - 1]].spm - grouped[keys[0]].spm;
    const defSpmDiff = grouped[keys[keys.length - 1]].defSpm - grouped[keys[0]].defSpm;
    trends.push(`<p><strong>SPM Trend</strong>: SPM checks ${spmDiff > 0 ? 'increased' : 'decreased'} by ${Math.abs(spmDiff)} from ${keys[0]} to ${keys[keys.length - 1]}.</p>`);
    trends.push(`<p><strong>SPM Deficiency Trend</strong>: SPM deficiencies ${defSpmDiff > 0 ? 'increased' : 'decreased'} by ${Math.abs(defSpmDiff)}.</p>`);
    const cvvrsDiff = grouped[keys[keys.length - 1]].cvvrs - grouped[keys[0]].cvvrs;
    trends.push(`<p><strong>CVVRS Trend</strong>: CVVRS checks ${cvvrsDiff > 0 ? 'increased' : 'decreased'} by ${Math.abs(cvvrsDiff)}.</p>`);
    const mobileDiff = grouped[keys[keys.length - 1]].mobile - grouped[keys[0]].mobile;
    trends.push(`<p><strong>Mobile Trend</strong>: Mobile checks ${mobileDiff > 0 ? 'increased' : 'decreased'} by ${Math.abs(mobileDiff)}.</p>`);
    const ambushDiff = grouped[keys[keys.length - 1]].ambush - grouped[keys[0]].ambush;
    trends.push(`<p><strong>Ambush Trend</strong>: Ambush checks ${ambushDiff > 0 ? 'increased' : 'decreased'} by ${Math.abs(ambushDiff)}.</p>`);
  }
  document.getElementById('trendSummary').innerHTML = `
    <h4>Data Trends</h4>
    ${trends.length ? trends.join('') : '<p>No trend data available (select a specific division or longer date range).</p>'}
  `;
}

function renderAnalysisTable() {
  const thead = document.getElementById('analysisHeader');
  const tbody = document.getElementById('analysisBody');
  const ambushThead = document.getElementById('ambushHeader');
  const ambushTbody = document.getElementById('ambushBody');
  const insightsDiv = document.getElementById('insights');
  const mode = selectedDivision === 'ALL' ? 'division' : 'date';
  const keys = Object.keys(grouped).sort();

  if (keys.length === 0) {
    tbody.innerHTML = '<tr><td colspan="13">No data available for the selected filters.</td></tr>';
    ambushTbody.innerHTML = '<tr><td colspan="25">No data available for the selected filters.</td></tr>';
    insightsDiv.innerHTML = '';
    return;
  }

  // Main Analysis Table
  thead.innerHTML = `
    <th onclick="sortAnalysisTable('key', 0)">${mode === 'division' ? 'Division' : 'Date'}</th>
    <th onclick="sortAnalysisTable('spm', 1)">SPM</th>
    <th onclick="sortAnalysisTable('defSpm', 2)">SPM Def</th>
    <th onclick="sortAnalysisTable('spmDefRate', 3)">SPM Def Rate</th>
    <th onclick="sortAnalysisTable('cvvrs', 4)">CVVRS</th>
    <th onclick="sortAnalysisTable('defCvvrs', 5)">CVVRS Def</th>
    <th onclick="sortAnalysisTable('cvvrsDefRate', 6)">CVVRS Def Rate</th>
    <th onclick="sortAnalysisTable('mobile', 7)">Mobile</th>
    <th onclick="sortAnalysisTable('defMobile', 8)">Mobile Def</th>
    <th onclick="sortAnalysisTable('mobileDefRate', 9)">Mobile Def Rate</th>
    <th onclick="sortAnalysisTable('ambush', 10)">Ambush</th>
    <th onclick="sortAnalysisTable('defAmbush', 11)">Ambush Def</th>
    <th onclick="sortAnalysisTable('ambushDefRate', 12)">Ambush Def Rate</th>
  `;

  tbody.innerHTML = '';
  const excelMainData = [];
  const sortedKeys = [...keys];
  let total = {spm:0,defSpm:0,cvvrs:0,defCvvrs:0,mobile:0,defMobile:0,ambush:0,defAmbush:0};
  sortedKeys.forEach(key => {
    const g = grouped[key];
    total.spm+=g.spm; total.defSpm+=g.defSpm;
    total.cvvrs+=g.cvvrs; total.defCvvrs+=g.defCvvrs;
    total.mobile+=g.mobile; total.defMobile+=g.defMobile;
    total.ambush+=g.ambush; total.defAmbush+=g.defAmbush;
    const spmDefRate = g.spm ? ((g.defSpm / g.spm) * 100).toFixed(2) : 0;
    const cvvrsDefRate = g.cvvrs ? ((g.defCvvrs / g.cvvrs) * 100).toFixed(2) : 0;
    const mobileDefRate = g.mobile ? ((g.defMobile / g.mobile) * 100).toFixed(2) : 0;
    const ambushDefRate = g.ambush ? ((g.defAmbush / g.ambush) * 100).toFixed(2) : 0;
    const row = `
      <tr>
        <td>${key}</td>
        <td>${g.spm}</td>
        <td>${g.defSpm}</td>
        <td class="${spmDefRate > 10 ? 'highlight-deficiency' : ''}">${spmDefRate}%</td>
        <td>${g.cvvrs}</td>
        <td>${g.defCvvrs}</td>
        <td class="${cvvrsDefRate > 10 ? 'highlight-deficiency' : ''}">${cvvrsDefRate}%</td>
        <td>${g.mobile}</td>
        <td>${g.defMobile}</td>
        <td class="${mobileDefRate > 10 ? 'highlight-deficiency' : ''}">${mobileDefRate}%</td>
        <td>${g.ambush}</td>
        <td>${g.defAmbush}</td>
        <td class="${ambushDefRate > 10 ? 'highlight-deficiency' : ''}">${ambushDefRate}%</td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
    excelMainData.push({
      [mode === 'division' ? 'Division' : 'Date']: key,
      'SPM': g.spm,
      'SPM Def': g.defSpm,
      'SPM Def Rate': spmDefRate,
      'CVVRS': g.cvvrs,
      'CVVRS Def': g.defCvvrs,
      'CVVRS Def Rate': cvvrsDefRate,
      'Mobile': g.mobile,
      'Mobile Def': g.defMobile,
      'Mobile Def Rate': mobileDefRate,
      'Ambush': g.ambush,
      'Ambush Def': g.defAmbush,
      'Ambush Def Rate': ambushDefRate
    });
  });
  // Add totals row
  const spmDefRate = total.spm ? ((total.defSpm / total.spm) * 100).toFixed(2) : 0;
  const cvvrsDefRate = total.cvvrs ? ((total.defCvvrs / total.cvvrs) * 100).toFixed(2) : 0;
  const mobileDefRate = total.mobile ? ((total.defMobile / total.mobile) * 100).toFixed(2) : 0;
  const ambushDefRate = total.ambush ? ((total.defAmbush / total.ambush) * 100).toFixed(2) : 0;
  tbody.insertAdjacentHTML('beforeend', `
    <tr style="font-weight:bold;background:#e6f0fa;">
      <td>Total</td>
      <td>${total.spm}</td>
      <td>${total.defSpm}</td>
      <td class="${spmDefRate > 10 ? 'highlight-deficiency' : ''}">${spmDefRate}%</td>
      <td>${total.cvvrs}</td>
      <td>${total.defCvvrs}</td>
      <td class="${cvvrsDefRate > 10 ? 'highlight-deficiency' : ''}">${cvvrsDefRate}%</td>
      <td>${total.mobile}</td>
      <td>${total.defMobile}</td>
      <td class="${mobileDefRate > 10 ? 'highlight-deficiency' : ''}">${mobileDefRate}%</td>
      <td>${total.ambush}</td>
      <td>${total.defAmbush}</td>
      <td class="${ambushDefRate > 10 ? 'highlight-deficiency' : ''}">${ambushDefRate}%</td>
    </tr>
  `);

  // Ambush Table
  ambushThead.innerHTML = `
    <th onclick="sortAmbushTable('key', 0)">${mode === 'division' ? 'Division' : 'Date'}</th>
    <th onclick="sortAmbushTable('ambush1', 1)">Yellow Signal DFC</th>
    <th onclick="sortAmbushTable('defAmbush1', 2)">Yellow Signal DFC Def</th>
    <th onclick="sortAmbushTable('ambush1DefRate', 3)">Yellow Signal DFC Def Rate</th>
    <th onclick="sortAmbushTable('ambush2', 4)">Yellow Signal IR</th>
    <th onclick="sortAmbushTable('defAmbush2', 5)">Yellow Signal IR Def</th>
    <th onclick="sortAmbushTable('ambush2DefRate', 6)">Yellow Signal IR Def Rate</th>
    <th onclick="sortAmbushTable('ambush3', 7)">ALP holding RS valve</th>
    <th onclick="sortAmbushTable('defAmbush3', 8)">ALP holding RS valve Def</th>
    <th onclick="sortAmbushTable('ambush3DefRate', 9)">ALP holding RS valve Def Rate</th>
    <th onclick="sortAmbushTable('ambush4', 10)">MEMUs/EMUs Speed</th>
    <th onclick="sortAmbushTable('defAmbush4', 11)">MEMUs/EMUs Speed Def</th>
    <th onclick="sortAmbushTable('ambush4DefRate', 12)">MEMUs/EMUs Speed Def Rate</th>
    <th onclick="sortAmbushTable('ambush5', 13)">IBH Signal Passed</th>
    <th onclick="sortAmbushTable('defAmbush5', 14)">IBH Signal Passed Def</th>
    <th onclick="sortAmbushTable('ambush5DefRate', 15)">IBH Signal Passed Def Rate</th>
    <th onclick="sortAmbushTable('ambush6', 16)">Running room wee Hours</th>
    <th onclick="sortAmbushTable('defAmbush6', 17)">Running room wee Hours Def</th>
    <th onclick="sortAmbushTable('ambush6DefRate', 18)">Running room wee Hours Def Rate</th>
    <th onclick="sortAmbushTable('ambush7', 19)">Stabling/Securing of Loads</th>
    <th onclick="sortAmbushTable('defAmbush7', 20)">Stabling/Securing of Loads Def</th>
    <th onclick="sortAmbushTable('ambush7DefRate', 21)">Stabling/Securing of Loads Def Rate</th>
    <th onclick="sortAmbushTable('ambush8', 22)">Shunting operations Checked</th>
    <th onclick="sortAmbushTable('defAmbush8', 23)">Shunting operations Checked Def</th>
    <th onclick="sortAmbushTable('ambush8DefRate', 24)">Shunting operations Checked Def Rate</th>
  `;

  ambushTbody.innerHTML = '';
  const excelAmbushData = [];
  let ambushTotal = {};
  for(let i=1;i<=8;i++){
    ambushTotal['ambush'+i]=0;
    ambushTotal['defAmbush'+i]=0;
  }
  sortedKeys.forEach(key => {
    const g = grouped[key];
    const row = `
      <tr>
        <td>${key}</td>
        ${Array.from({length: 8}, (_, i) => {
          const ambushVal = g[`ambush${i+1}`] || 0;
          const defAmbushVal = g[`defAmbush${i+1}`] || 0;
          const defRate = ambushVal ? ((defAmbushVal / ambushVal) * 100).toFixed(2) : 0;
          ambushTotal['ambush'+(i+1)] += ambushVal;
          ambushTotal['defAmbush'+(i+1)] += defAmbushVal;
          return `
            <td>${ambushVal}</td>
            <td>${defAmbushVal}</td>
            <td class="${defRate > 10 ? 'highlight-deficiency' : ''}">${defRate}%</td>
          `;
        }).join('')}
      </tr>
    `;
    ambushTbody.insertAdjacentHTML('beforeend', row);
    excelAmbushData.push({
      [mode === 'division' ? 'Division' : 'Date']: key,
      'Yellow Signal DFC': g.ambush1 || 0,
      'Yellow Signal DFC Def': g.defAmbush1 || 0,
      'Yellow Signal DFC Def Rate': g.ambush1 ? ((g.defAmbush1 / g.ambush1) * 100).toFixed(2) : 0,
      'Yellow Signal IR': g.ambush2 || 0,
      'Yellow Signal IR Def': g.defAmbush2 || 0,
      'Yellow Signal IR Def Rate': g.ambush2 ? ((g.defAmbush2 / g.ambush2) * 100).toFixed(2) : 0,
      'ALP holding RS valve': g.ambush3 || 0,
      'ALP holding RS valve Def': g.defAmbush3 || 0,
      'ALP holding RS valve Def Rate': g.ambush3 ? ((g.defAmbush3 / g.ambush3) * 100).toFixed(2) : 0,
      'MEMUs/EMUs Speed': g.ambush4 || 0,
      'MEMUs/EMUs Speed Def': g.defAmbush4 || 0,
      'MEMUs/EMUs Speed Def Rate': g.ambush4 ? ((g.defAmbush4 / g.ambush4) * 100).toFixed(2) : 0,
      'IBH Signal Passed': g.ambush5 || 0,
      'IBH Signal Passed Def': g.defAmbush5 || 0,
      'IBH Signal Passed Def Rate': g.ambush5 ? ((g.defAmbush5 / g.ambush5) * 100).toFixed(2) : 0,
      'Running room wee Hours': g.ambush6 || 0,
      'Running room wee Hours Def': g.defAmbush6 || 0,
      'Running room wee Hours Def Rate': g.ambush6 ? ((g.defAmbush6 / g.ambush6) * 100).toFixed(2) : 0,
      'Stabling/Securing of Loads': g.ambush7 || 0,
      'Stabling/Securing of Loads Def': g.defAmbush7 || 0,
      'Stabling/Securing of Loads Def Rate': g.ambush7 ? ((g.defAmbush7 / g.ambush7) * 100).toFixed(2) : 0,
      'Shunting operations Checked': g.ambush8 || 0,
      'Shunting operations Checked Def': g.defAmbush8 || 0,
      'Shunting operations Checked Def Rate': g.ambush8 ? ((g.defAmbush8 / g.ambush8) * 100).toFixed(2) : 0
    });
  });
  // Add totals row for ambush table
  ambushTbody.insertAdjacentHTML('beforeend', `
    <tr style="font-weight:bold;background:#e6f0fa;">
      <td>Total</td>
      ${Array.from({length:8},(_,i)=>{
        const ambushVal=ambushTotal['ambush'+(i+1)];
        const defAmbushVal=ambushTotal['defAmbush'+(i+1)];
        const defRate=ambushVal?((defAmbushVal/ambushVal)*100).toFixed(2):0;
        return `
          <td>${ambushVal}</td>
          <td>${defAmbushVal}</td>
          <td class="${defRate>10?'highlight-deficiency':''}">${defRate}%</td>
        `;
      }).join('')}
    </tr>
  `);

  // AI Insights
  const insights = [];
  const spmMax = Math.max(...keys.map(k => grouped[k].spm));
  const spmMin = Math.min(...keys.map(k => grouped[k].spm));
  const spmDefMax = Math.max(...keys.map(k => grouped[k].defSpm));
  const cvvrsMax = Math.max(...keys.map(k => grouped[k].cvvrs));
  const cvvrsMin = Math.min(...keys.map(k => grouped[k].cvvrs));
  const cvvrsDefMax = Math.max(...keys.map(k => grouped[k].defCvvrs));
  const mobileMax = Math.max(...keys.map(k => grouped[k].mobile));
  const mobileMin = Math.min(...keys.map(k => grouped[k].mobile));
  const mobileDefMax = Math.max(...keys.map(k => grouped[k].defMobile));
  const ambushMax = Math.max(...keys.map(k => grouped[k].ambush));
  const ambushMin = Math.min(...keys.map(k => grouped[k].ambush));
  const ambushDefMax = Math.max(...keys.map(k => grouped[k].defAmbush));

  const spmTop = keys.find(k => grouped[k].spm === spmMax);
  const spmBottom = keys.find(k => grouped[k].spm === spmMin);
  const spmDefTop = keys.find(k => grouped[k].defSpm === spmDefMax);
  const cvvrsTop = keys.find(k => grouped[k].cvvrs === cvvrsMax);
  const cvvrsBottom = keys.find(k => grouped[k].cvvrs === cvvrsMin);
  const cvvrsDefTop = keys.find(k => grouped[k].defCvvrs === cvvrsDefMax);
  const mobileTop = keys.find(k => grouped[k].mobile === mobileMax);
  const mobileBottom = keys.find(k => grouped[k].mobile === mobileMin);
  const mobileDefTop = keys.find(k => grouped[k].defMobile === mobileDefMax);
  const ambushTop = keys.find(k => grouped[k].ambush === ambushMax);
  const ambushBottom = keys.find(k => grouped[k].ambush === ambushMin);
  const ambushDefTop = keys.find(k => grouped[k].defAmbush === ambushDefMax);

  insights.push(`<h4>AI-Driven Insights</h4>`);
  if (spmTop) insights.push(`<p><strong>SPM Performance</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${spmTop} has the highest SPM checks (${spmMax}), while ${spmBottom} has the lowest (${spmMin}).</p>`);
  if (spmDefTop) insights.push(`<p><strong>SPM Deficiencies</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${spmDefTop} has the highest SPM deficiencies (${spmDefMax}). Review processes to reduce errors.</p>`);
  if (cvvrsTop) insights.push(`<p><strong>CVVRS Performance</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${cvvrsTop} leads in CVVRS checks (${cvvrsMax}), while ${cvvrsBottom} has the lowest (${cvvrsMin}).</p>`);
  if (cvvrsDefTop) insights.push(`<p><strong>CVVRS Deficiencies</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${cvvrsDefTop} has the highest CVVRS deficiencies (${cvvrsDefMax}).</p>`);
  if (mobileTop) insights.push(`<p><strong>Mobile Performance</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${mobileTop} has the highest Mobile checks (${mobileMax}), while ${mobileBottom} has the lowest (${mobileMin}).</p>`);
  if (mobileDefTop) insights.push(`<p><strong>Mobile Deficiencies</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${mobileDefTop} has the highest Mobile deficiencies (${mobileDefMax}).</p>`);
  if (ambushTop) insights.push(`<p><strong>Ambush Performance</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${ambushTop} has the highest Ambush checks (${ambushMax}), while ${ambushBottom} has the lowest (${ambushMin}).</p>`);
  if (ambushDefTop) insights.push(`<p><strong>Ambush Deficiencies</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${ambushDefTop} has the highest Ambush deficiencies (${ambushDefMax}).</p>`);

  const highDefRate = keys.map(k => ({
    key,
    spmDefRate: grouped[k].spm ? (grouped[k].defSpm / grouped[k].spm) * 100 : 0,
    cvvrsDefRate: grouped[k].cvvrs ? (grouped[k].defCvvrs / grouped[k].cvvrs) * 100 : 0,
    mobileDefRate: grouped[k].mobile ? (grouped[k].defMobile / grouped[k].mobile) * 100 : 0,
    ambushDefRate: grouped[k].ambush ? (grouped[k].defAmbush / grouped[k].ambush) * 100 : 0
  }));
  const highSpmDefRate = highDefRate.reduce((a, b) => a.spmDefRate > b.spmDefRate ? a : b, { spmDefRate: 0 });
  const highCvvrsDefRate = highDefRate.reduce((a, b) => a.cvvrsDefRate > b.cvvrsDefRate ? a : b, { cvvrsDefRate: 0 });
  const highMobileDefRate = highDefRate.reduce((a, b) => a.mobileDefRate > b.mobileDefRate ? a : b, { mobileDefRate: 0 });
  const highAmbushDefRate = highDefRate.reduce((a, b) => a.ambushDefRate > b.ambushDefRate ? a : b, { ambushDefRate: 0 });

  if (highSpmDefRate.spmDefRate > 10) insights.push(`<p><strong>High SPM Deficiency Rate</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${highSpmDefRate.key} has a high SPM deficiency rate (${highSpmDefRate.spmDefRate.toFixed(2)}%). Investigate potential issues.</p>`);
  if (highCvvrsDefRate.cvvrsDefRate > 10) insights.push(`<p><strong>High CVVRS Deficiency Rate</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${highCvvrsDefRate.key} has a high CVVRS deficiency rate (${highCvvrsDefRate.cvvrsDefRate.toFixed(2)}%).</p>`);
  if (highMobileDefRate.mobileDefRate > 10) insights.push(`<p><strong>High Mobile Deficiency Rate</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${highMobileDefRate.key} has a high Mobile deficiency rate (${highMobileDefRate.mobileDefRate.toFixed(2)}%).</p>`);
  if (highAmbushDefRate.ambushDefRate > 10) insights.push(`<p><strong>High Ambush Deficiency Rate</strong>: ${mode === 'division' ? 'Division' : 'Date'} ${highAmbushDefRate.key} has a high Ambush deficiency rate (${highAmbushDefRate.ambushDefRate.toFixed(2)}%).</p>`);

  insightsDiv.innerHTML = insights.join('');

  document.getElementById('excelExportBtn').dataset.excelMainData = JSON.stringify(excelMainData);
  document.getElementById('excelExportBtn').dataset.excelAmbushData = JSON.stringify(excelAmbushData);
}

function sortAnalysisTable(column, index) {
  const mode = selectedDivision === 'ALL' ? 'division' : 'date';
  const keys = Object.keys(grouped);
  keys.sort((a, b) => {
    if (column === 'key') return a.localeCompare(b);
    if (column.endsWith('DefRate')) {
      const metric = column.replace('DefRate', '');
      const aRate = grouped[a][metric] ? (grouped[a][`def${metric.charAt(0).toUpperCase() + metric.slice(1)}`] / grouped[a][metric]) * 100 : 0;
      const bRate = grouped[b][metric] ? (grouped[b][`def${metric.charAt(0).toUpperCase() + metric.slice(1)}`] / grouped[b][metric]) * 100 : 0;
      return bRate - aRate;
    }
    return grouped[b][column] - grouped[a][column];
  });
  renderAnalysisTable();
}

function sortAmbushTable(column, index) {
  const mode = selectedDivision === 'ALL' ? 'division' : 'date';
  const keys = Object.keys(grouped);
  keys.sort((a, b) => {
    if (column === 'key') return a.localeCompare(b);
    if (column.includes('DefRate')) {
      const i = parseInt(column.match(/\d+/)[0]);
      const aRate = grouped[a][`ambush${i}`] ? (grouped[a][`defAmbush${i}`] / grouped[a][`ambush${i}`]) * 100 : 0;
      const bRate = grouped[b][`ambush${i}`] ? (grouped[b][`defAmbush${i}`] / grouped[b][`ambush${i}`]) * 100 : 0;
      return bRate - aRate;
    }
    const i = column.includes('defAmbush') ? parseInt(column.match(/\d+/)[0]) : parseInt(column.match(/\d+/)[0]);
    return grouped[b][column] - grouped[a][column];
  });
  renderAnalysisTable();
}

function exportToExcel() {
  const mainData = JSON.parse(document.getElementById('excelExportBtn').dataset.excelMainData || '[]');
  const ambushData = JSON.parse(document.getElementById('excelExportBtn').dataset.excelAmbushData || '[]');
  if (mainData.length === 0 && ambushData.length === 0) {
    alert('No data available to export.');
    return;
  }
  const wb = XLSX.utils.book_new();
  if (mainData.length) {
    const wsMain = XLSX.utils.json_to_sheet(mainData);
    XLSX.utils.book_append_sheet(wb, wsMain, 'Main Metrics');
  }
  if (ambushData.length) {
    const wsAmbush = XLSX.utils.json_to_sheet(ambushData);
    XLSX.utils.book_append_sheet(wb, wsAmbush, 'Ambush Performance Details');
  }
  const today = new Date().toISOString().split('T')[0];
  XLSX.write(wb, `Crew_Performance_Analysis_${today}.xlsx`);
}

function selectDivisionRow(division) {
  selectedDivision = division;
  renderAllCharts();
  renderDivisionButtons();
}

function showDeficiencyPopup(chartId) {
  // Find which metric this chart is for
  let metric = '';
  if (chartId === 'spmChart') metric = 'spm';
  else if (chartId === 'cvvrsChart') metric = 'cvvrs';
  else if (chartId === 'mobileChart') metric = 'mobile';
  else if (chartId === 'ambushChart') metric = 'ambush';
  else if (/^ambush\dChart$/.test(chartId)) metric = chartId.replace('Chart','').toLowerCase();
  else return;

  // Find deficiency data
  let details = [];
  Object.keys(deficiencyMap).forEach(key => {
    deficiencyMap[key].forEach(item => {
      if (metric === 'spm' && item.spm > 0) details.push(item);
      else if (metric === 'cvvrs' && item.cvvrs > 0) details.push(item);
      else if (metric === 'mobile' && item.mobile > 0) details.push(item);
      else if (metric === 'ambush' && item.ambush > 0) details.push(item);
      // For ambush1..8
      else if (/^ambush\d$/.test(metric)) {
        // Not available in deficiencyMap, so skip for sub-ambush
      }
    });
  });
  // Render details
  let html = '<button class="screenshot-btn" id="defScreenshotBtn" style="float:right;margin-bottom:8px;">ðŸ“¸ Screenshot</button>';
  if (details.length === 0) {
    html += '<p>No deficiency details available for this metric.</p>';
  } else {
    html += `<table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Division</th>
          <th>Name</th>
          <th>Remarks</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        ${details.map(d=>`
          <tr>
            <td>${d.date}</td>
            <td>${d.division}</td>
            <td>${d.name}</td>
            <td>${d.remarks}</td>
            <td>${d[metric]}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>`;
  }
  document.getElementById('deficiencyDetails').innerHTML = html;
  document.getElementById('deficiencyPopup').style.display = 'block';
}

// Chart click event for deficiency charts (robust and always works)
function renderChart(id, label, data1, defData, labels) {
  const ctx = document.getElementById(id).getContext('2d');
  if (charts[id]) charts[id].destroy();
  let datasets;
  if (showOnlyDeficiency) {
    datasets = [
      { label: `${label} Deficiency`, data: defData, backgroundColor: chartType === 'bar' ? '#ff4d4d' : 'transparent', borderColor: '#ff4d4d', borderWidth: 2, fill: chartType === 'line' }
    ];
  } else {
    datasets = [
      { label, data: data1, backgroundColor: chartType === 'bar' ? '#0074D9' : 'transparent', borderColor: '#0074D9', borderWidth: 2, fill: chartType === 'line' },
      { label: `${label} Deficiency`, data: defData, backgroundColor: chartType === 'bar' ? '#ff4d4d' : 'transparent', borderColor: '#ff4d4d', borderWidth: 2, fill: chartType === 'line' }
    ];
  }
  charts[id] = new Chart(ctx, {
    type: chartType,
    data: {
      labels,
      datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        datalabels: {
          color: '#222',
          anchor: 'end',
          align: 'top',
          font: { weight: 'bold', size: 10 },
          formatter: v => v || ''
        },
        legend: { display: false },
        title: { display: false }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: '#e0e6ef' } },
        x: { grid: { color: '#e0e6ef' } }
      }
    },
    plugins: [ChartDataLabels]
  });
  ctx.canvas.onclick = function(evt) {
    const points = charts[id].getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
    if (points.length) {
      const datasetIndex = points[0].datasetIndex;
      // If only deficiency is shown, datasetIndex is 0
      if ((showOnlyDeficiency && datasetIndex === 0) || (!showOnlyDeficiency && datasetIndex === 1)) {
        showDeficiencyPopup(id, points[0].index);
      }
    }
  };
}
</script>
</body>
</html>
