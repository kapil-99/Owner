<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crew Performance Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      background: #f5f7fa;
      color: #1a1a1a;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 0.75rem;
      background: #fff;
      border-bottom: 1px solid #e0e6ef;
      justify-content: flex-start;
    }
    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      padding: 1rem;
      background: linear-gradient(to right, #003366, #0074D9);
    }
    .date-picker, .division-input {
      padding: 0.5rem;
      font-size: 0.95rem;
      border-radius: 0.375rem;
      border: 1px solid #b0c4de;
      background: #f8fafc;
      color: #003366;
      outline: none;
      width: 200px;
    }
    .btn, .header-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: 1px solid #0074D9;
      background: #0074D9;
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn:hover, .header-btn:hover {
      background: #003366;
      transform: scale(1.05);
    }
    .filter-btn {
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      border-radius: 0.375rem;
      border: 1px solid #0074D9;
      background: #e6f0fa;
      color: #003366;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .filter-btn:hover {
      background: #b0c4de;
    }
    .filter-btn.active {
      background: #0074D9;
      color: #fff;
      border-color: #003366;
    }
    .table-container {
      max-width: 98%;
      margin: 1rem auto;
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 6px rgba(0, 51, 102, 0.1);
      overflow-x: auto;
      padding: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }
    th {
      background: #0074D9;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th:hover {
      background: #003366;
    }
    th, td {
      border: 1px solid #e0e6ef;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.9rem;
      min-width: 60px;
    }
    tr:nth-child(even) td {
      background: #f8fafc;
    }
    tr:hover td {
      background: #e6f0fa;
    }
    .section-header {
      margin: 2rem 0 1rem;
      font-size: 1.5rem;
      font-weight: 600;
      color: #003366;
      text-align: center;
    }
    .button-container {
      margin: 1rem auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
    }
    .pagination {
      margin: 1rem auto;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }
    .pagination-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      border: 1px solid #0074D9;
      background: #e6f0fa;
      color: #003366;
      cursor: pointer;
      transition: background 0.2s;
    }
    .pagination-btn:hover {
      background: #b0c4de;
    }
    .pagination-btn.disabled {
      background: #d3d3d3;
      cursor: not-allowed;
    }
    .division-group-header {
      background: #e0e6ef;
      font-weight: bold;
      text-align: left;
      padding: 0.5rem;
    }
    .hidden {
      display: none;
    }
    .cat-spm { background-color: #e6f3ff; }
    .cat-cvvrs { background-color: #e6ffe6; }
    .cat-cug { background-color: #ffe6e6; }
    .cat-personal-mob { background-color: #fff5e6; }
    .cat-mob-declaration { background-color: #e6e6ff; }
    .cat-lobby-online { background-color: #f0e6ff; }
    .cat-yellow-dfc { background-color: #ffffe6; }
    .cat-yellow-ir { background-color: #e6fff0; }
    .cat-alp-rs { background-color: #ffe6f0; }
    .cat-memu-speed { background-color: #e6faff; }
    .cat-ibs-signal { background-color: #f0ffe6; }
    .cat-running-room { background-color: #ffe6ff; }
    .cat-stabling { background-color: #e6f0ff; }
    .cat-shunting { background-color: #fffae6; }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 1.5rem;
      border-radius: 0.5rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: #003366;
    }
    .preview-page {
      border: 1px solid #e0e6ef;
      padding: 0.5rem;
      margin: 0.5rem 0;
      background: #fff;
      font-size: 0.8rem;
    }
    .preview-page img {
      max-width: 100%;
      height: auto;
      border: 1px solid #e0e6ef;
    }
    .preview-controls {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .preview-controls label {
      font-weight: 500;
      color: #003366;
    }
    .preview-controls input[type="range"] {
      width: 100%;
    }
    .preview-controls .btn {
      margin-top: 0.5rem;
    }
    @media (max-width: 768px) {
      .top-bar, .button-container, .header-buttons {
        flex-direction: column;
        align-items: stretch;
      }
      .date-picker, .division-input {
        width: 100%;
      }
      th, td {
        font-size: 0.8rem;
        padding: 0.4rem;
        min-width: 50px;
      }
      .table-container {
        padding: 0.5rem;
      }
    }
    @media (max-width: 480px) {
      th, td {
        font-size: 0.7rem;
        padding: 0.3rem;
        min-width: 40px;
      }
      .btn, .header-btn, .filter-btn, .pagination-btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }
      .section-header {
        font-size: 1.2rem;
      }
      .modal-content {
        width: 95%;
        padding: 1rem;
      }
    }
    .pdf-table {
      font-size: 8px;
      width: 100%;
      border-collapse: collapse;
    }
    .pdf-table th, .pdf-table td {
      border: 1px solid #e0e6ef;
      padding: 3px;
      text-align: center;
      word-break: break-word;
      white-space: normal;
      min-width: 60px;
    }
    .pdf-table th {
      background: #0074D9;
      color: #fff;
    }
    .pdf-table tr:nth-child(even) td {
      background: #f8fafc;
    }
    .pdf-table .division-group-header {
      background: #e0e6ef;
      text-align: left;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header-buttons">
    <button class="header-btn" id="page1Btn">Crew Performance Dashboard</button>
    <button class="header-btn" id="page2Btn">Page 2 (Coming Soon)</button>
    <button class="header-btn" id="page3Btn">Page 3 (Coming Soon)</button>
    <button class="header-btn" id="page4Btn">Page 4 (Coming Soon)</button>
    <button class="header-btn" id="page5Btn">Page 5 (Coming Soon)</button>
  </div>

  <div class="top-bar">
    <input type="text" id="datePicker" class="date-picker" placeholder="Select Date Range">
    <input type="text" id="divisionInput" class="division-input" placeholder="Enter Division (Optional)">
    <button class="btn" id="resetBtn">ðŸ”„ Reset Filters</button>
    <button class="btn" id="excelBtn">ðŸ“¥ Export to Excel</button>
    <button class="btn" id="pdfBtn">ðŸ“„ Export to PDF</button>
    <button class="btn" id="toggleDivisionSummaryBtn">ðŸ“Š Show Division Summary</button>
  </div>

  <div class="table-container">
    <table id="summaryTable" class="pdf-table">
      <thead id="summaryHeader"></thead>
      <tbody id="summaryBody"></tbody>
    </table>
  </div>

  <h3 class="section-header hidden" id="divisionSummaryHeader">Division-Based Summary</h3>
  <div class="table-container hidden" id="divisionSummaryContainer">
    <table id="divisionSummaryTable" class="pdf-table">
      <thead id="divisionSummaryTableHeader"></thead>
      <tbody id="divisionSummaryTableBody"></tbody>
    </table>
  </div>

  <h3 class="section-header">Remarks Details</h3>
  <div class="button-container" id="divisionButtons"></div>
  <div class="button-container" id="categoryButtons"></div>
  <div class="table-container">
    <table id="remarksTable" class="pdf-table">
      <thead id="remarksHeader"></thead>
      <tbody id="remarksBody"></tbody>
    </table>
  </div>
  <div class="pagination">
    <button class="pagination-btn" id="prevPageBtn">Previous</button>
    <span id="pageInfo"></span>
    <button class="pagination-btn" id="nextPageBtn">Next</button>
  </div>

  <div id="pdfPreviewModal" class="modal">
    <div class="modal-content">
      <h2>PDF Page Preview</h2>
      <div id="previewContent"></div>
      <div class="preview-controls">
        <label>Font Size (pt): <span id="fontSizeValue">8</span></label>
        <input type="range" id="fontSizeSlider" min="6" max="10" value="8" step="0.5">
        <label>Column Width Multiplier: <span id="columnWidthValue">1.0</span></label>
        <input type="range" id="columnWidthSlider" min="0.8" max="1.5" value="1.0" step="0.1">
        <label>Margins (mm): <span id="marginValue">8</span></label>
        <input type="range" id="marginSlider" min="5" max="12" value="8" step="1">
        <button class="btn" id="confirmPdfBtn">Confirm and Export</button>
        <button class="btn" id="cancelPdfBtn">Cancel</button>
      </div>
    </div>
  </div>

<script>
const { jsPDF } = window.jspdf;
const SHEET_ID = '12mtmU8RBHFLUpFXYCdGH96mMBL_Ec6cpvh0dR_CotZg';
const API_KEY = 'AIzaSyBkKVtdfFbFfdFE8FqSaUGZvptxj0Fysco';
const RANGE = 'CrewData!A1:AJ1000';
let allData = [], headers = [], summaryData = [], divisionSummaryData = {}, remarksData = [];
let selectedDivision = '', buttonDivision = '', buttonCategory = '';
let fromDate = '', toDate = '', showDivisionSummary = false;
let currentPage = 1, rowsPerPage = 100;
let pdfSettings = { fontSize: 8, columnWidthMultiplier: 1.0, margin: 8 };

// Fetch data with error handling
async function fetchData() {
  try {
    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    const data = await res.json();
    allData = data.values || [];
    if (allData.length === 0) throw new Error('No data received from Google Sheets');
    headers = allData[0] || [];
    initUI();
    renderTables();
  } catch (err) {
    console.error('Fetch Error:', err);
    alert('Error fetching data. Please check your internet connection or try again later.');
  }
}
fetchData();

function addOneDay(dateStr) {
  if (!dateStr) return '';
  let date = new Date(dateStr);
  date.setDate(date.getDate() + 1);
  return date.toISOString().split('T')[0];
}

function initUI() {
  const today = new Date();
  const defaultFrom = new Date();
  defaultFrom.setDate(today.getDate() - 6);
  fromDate = addOneDay(defaultFrom.toISOString().split('T')[0]);
  toDate = addOneDay(today.toISOString().split('T')[0]);

  flatpickr('#datePicker', {
    mode: 'range',
    dateFormat: 'Y-m-d',
    defaultDate: [fromDate, toDate],
    static: true,
    onChange: (selectedDates) => {
      if (selectedDates.length === 2) {
        const inputFrom = selectedDates[0].toISOString().split('T')[0];
        const inputTo = selectedDates[1].toISOString().split('T')[0];
        fromDate = addOneDay(inputFrom);
        toDate = addOneDay(inputTo);
        if (fromDate > toDate) {
          alert('Start date cannot be later than end date.');
          fromDate = toDate;
          document.getElementById('datePicker')._flatpickr.setDate([inputTo, inputTo]);
        }
        currentPage = 1;
        renderTables();
      }
    }
  });

  document.getElementById('divisionInput').addEventListener('input', function() {
    selectedDivision = this.value.trim();
    currentPage = 1;
    renderTables();
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    selectedDivision = '';
    buttonDivision = '';
    buttonCategory = '';
    showDivisionSummary = false;
    currentPage = 1;
    document.getElementById('divisionInput').value = '';
    document.getElementById('toggleDivisionSummaryBtn').textContent = 'ðŸ“Š Show Division Summary';
    document.getElementById('divisionSummaryHeader').classList.add('hidden');
    document.getElementById('divisionSummaryContainer').classList.add('hidden');
    const today = new Date();
    const defaultFrom = new Date();
    defaultFrom.setDate(today.getDate() - 6);
    fromDate = addOneDay(defaultFrom.toISOString().split('T')[0]);
    toDate = addOneDay(today.toISOString().split('T')[0]);
    document.getElementById('datePicker')._flatpickr.setDate([fromDate, toDate]);
    renderTables();
  });

  document.getElementById('toggleDivisionSummaryBtn').addEventListener('click', () => {
    showDivisionSummary = !showDivisionSummary;
    document.getElementById('toggleDivisionSummaryBtn').textContent = showDivisionSummary ? 'ðŸ“Š Hide Division Summary' : 'ðŸ“Š Show Division Summary';
    document.getElementById('divisionSummaryHeader').classList.toggle('hidden', !showDivisionSummary);
    document.getElementById('divisionSummaryContainer').classList.toggle('hidden', !showDivisionSummary);
    renderTables();
  });

  document.getElementById('excelBtn').addEventListener('click', exportToExcel);
  document.getElementById('pdfBtn').addEventListener('click', showPdfPreview);

  document.getElementById('prevPageBtn').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderTables();
    }
  });

  document.getElementById('nextPageBtn').addEventListener('click', () => {
    if (currentPage < Math.ceil(remarksData.length / rowsPerPage)) {
      currentPage++;
      renderTables();
    }
  });

  document.getElementById('page1Btn').addEventListener('click', () => {
    window.location.reload();
  });
  ['page2Btn', 'page3Btn', 'page4Btn', 'page5Btn'].forEach(id => {
    document.getElementById(id).addEventListener('click', () => {
      alert('Coming Soon');
    });
  });

  document.getElementById('fontSizeSlider').addEventListener('input', function() {
    pdfSettings.fontSize = parseFloat(this.value);
    document.getElementById('fontSizeValue').textContent = this.value;
    showPdfPreview();
  });
  document.getElementById('columnWidthSlider').addEventListener('input', function() {
    pdfSettings.columnWidthMultiplier = parseFloat(this.value);
    document.getElementById('columnWidthValue').textContent = this.value;
    showPdfPreview();
  });
  document.getElementById('marginSlider').addEventListener('input', function() {
    pdfSettings.margin = parseInt(this.value);
    document.getElementById('marginValue').textContent = this.value;
    showPdfPreview();
  });
  document.getElementById('confirmPdfBtn').addEventListener('click', exportToPDF);
  document.getElementById('cancelPdfBtn').addEventListener('click', () => {
    document.getElementById('pdfPreviewModal').style.display = 'none';
  });
}

function renderTables() {
  const idx = name => headers.indexOf(name);
  const categories = [
    { sn: 1, name: 'No. of SPMs Analyzed', checkCol: 2, defCol: 3, class: 'cat-spm' },
    { sn: 2, name: 'No. of CVVRS Analyzed', checkCol: 4, defCol: 5, class: 'cat-cvvrs' },
    { sn: 3, name: 'CUG Checked', checkCol: 6, defCol: 7, class: 'cat-cug' },
    { sn: 4, name: 'Personal Mob. Checked', checkCol: 8, defCol: 9, class: 'cat-personal-mob' },
    { sn: 5, name: 'Mob. Declaration', checkCol: 10, defCol: 11, class: 'cat-mob-declaration' },
    { sn: 6, name: 'Lobby + Online', checkCol: [12, 13], defCol: 14, class: 'cat-lobby-online' },
    { sn: 7, name: 'Ambush - Passing Yellow Yellow Signal DFC', checkCol: 15, defCol: 16, class: 'cat-yellow-dfc' },
    { sn: 8, name: 'Ambush - Passing Yellow Signal IR', checkCol: 17, defCol: 18, class: 'cat-yellow-ir' },
    { sn: 9, name: 'ALP RS Valve (Yellow Signal IR)', checkCol: 19, defCol: 20, class: 'cat-alp-rs' },
    { sn: 10, name: 'MEMU/EMU Speed at PF Entry', checkCol: 21, defCol: 22, class: 'cat-memu-speed' },
    { sn: 11, name: 'IBH Signal Passed as per Rule', checkCol: 23, defCol: 24, class: 'cat-ibs-signal' },
    { sn: 12, name: 'Running Room (Wee Hours)', checkCol: 25, defCol: 26, class: 'cat-running-room' },
    { sn: 13, name: 'Stabling/Securing of Loads', checkCol: 27, defCol: 28, class: 'cat-stabling' },
    { sn: 14, name: 'Shunting operations', checkCol: 29, defCol: 30, class: 'cat-shunting' }
  ];
  const deficiencyColumns = [3, 5, 7, 9, 11, 14, 16, 18, 20, 22, 24, 26, 28, 30];
  const divisionSummaryColumns = {
    division: 1,
    spm: 2,
    defSpm: 3,
    cvvrs: 4,
    defCvvrs: 5,
    cugChecked: 6,
    cugMisused: 7,
    personalMobChecked: 8,
    personalMobMisused: 9,
    mobDeclaration: 10,
    mismatch: 11,
    lobbyOnline: [12, 13],
    mobDef: 14,
    yellowYellowDfc: 15,
    defYellowYellowDfc: 16,
    yellowIr: 17,
    defYellowIr: 18,
    alpRsValve: 19,
    defAlpRsValve: 20,
    memuSpeed: 21,
    overspeeding: 22,
    ibsSignal: 23,
    defIbsSignal: 24,
    runningRoom: 25,
    defRunningRoom: 26,
    stablingChecked: 27,
    defStabling: 28,
    shuntingChecked: 29,
    defShunting: 30
  };

  const divisionData = {};
  allData.slice(2).forEach(r => {
    const date = r[idx('Date')], division = r[1];
    if (!division || !date) return;
    if (date < fromDate || date > toDate) return;
    if (selectedDivision && division !== selectedDivision) return;

    if (!divisionData[division]) {
      divisionData[division] = categories.reduce((acc, cat) => {
        acc[cat.sn] = { checks: 0, deficiencies: 0 };
        return acc;
      }, {});
    }

    categories.forEach(cat => {
      if (Array.isArray(cat.checkCol)) {
        cat.checkCol.forEach(col => {
          divisionData[division][cat.sn].checks += Number(r[col] || 0);
        });
      } else {
        divisionData[division][cat.sn].checks += Number(r[cat.checkCol] || 0);
      }
      divisionData[division][cat.sn].deficiencies += Number(r[cat.defCol] || 0);
    });
  });

  summaryData = categories.map(cat => {
    const checks = Object.values(divisionData).reduce((sum, div) => sum + div[cat.sn].checks, 0);
    const deficiencies = Object.values(divisionData).reduce((sum, div) => sum + div[cat.sn].deficiencies, 0);
    const divisionsWithDef = Object.keys(divisionData)
      .filter(div => divisionData[div][cat.sn].deficiencies > 0)
      .join(', ');
    return {
      sn: cat.sn,
      category: cat.name,
      checks,
      deficiencies,
      divisionsWithDef: divisionsWithDef || 'None'
    };
  });

  divisionSummaryData = {};
  allData.slice(2).forEach(r => {
    const date = r[idx('Date')], division = r[1];
    if (!division || !date) return;
    if (date < fromDate || date > toDate) return;
    if (selectedDivision && division !== selectedDivision) return;

    if (!divisionSummaryData[division]) {
      divisionSummaryData[division] = {
        spm: 0, defSpm: 0, cvvrs: 0, defCvvrs: 0, cugChecked: 0, cugMisused: 0,
        personalMobChecked: 0, personalMobMisused: 0, mobDeclaration: 0, mismatch: 0,
        lobbyOnline: 0, mobDef: 0, yellowYellowDfc: 0, defYellowYellowDfc: 0,
        yellowIr: 0, defYellowIr: 0, alpRsValve: 0, defAlpRsValve: 0,
        memuSpeed: 0, overspeeding: 0, ibsSignal: 0, defIbsSignal: 0,
        runningRoom: 0, defRunningRoom: 0, stablingChecked: 0, defStabling: 0,
        shuntingChecked: 0, defShunting: 0
      };
    }
    divisionSummaryData[division].spm += Number(r[divisionSummaryColumns.spm] || 0);
    divisionSummaryData[division].defSpm += Number(r[divisionSummaryColumns.defSpm] || 0);
    divisionSummaryData[division].cvvrs += Number(r[divisionSummaryColumns.cvvrs] || 0);
    divisionSummaryData[division].defCvvrs += Number(r[divisionSummaryColumns.defCvvrs] || 0);
    divisionSummaryData[division].cugChecked += Number(r[divisionSummaryColumns.cugChecked] || 0);
    divisionSummaryData[division].cugMisused += Number(r[divisionSummaryColumns.cugMisused] || 0);
    divisionSummaryData[division].personalMobChecked += Number(r[divisionSummaryColumns.personalMobChecked] || 0);
    divisionSummaryData[division].personalMobMisused += Number(r[divisionSummaryColumns.personalMobMisused] || 0);
    divisionSummaryData[division].mobDeclaration += Number(r[divisionSummaryColumns.mobDeclaration] || 0);
    divisionSummaryData[division].mismatch += Number(r[divisionSummaryColumns.mismatch] || 0);
    divisionSummaryData[division].lobbyOnline += Number(r[divisionSummaryColumns.lobbyOnline[0]] || 0) + Number(r[divisionSummaryColumns.lobbyOnline[1]] || 0);
    divisionSummaryData[division].mobDef += Number(r[divisionSummaryColumns.mobDef] || 0);
    divisionSummaryData[division].yellowYellowDfc += Number(r[divisionSummaryColumns.yellowYellowDfc] || 0);
    divisionSummaryData[division].defYellowYellowDfc += Number(r[divisionSummaryColumns.defYellowYellowDfc] || 0);
    divisionSummaryData[division].yellowIr += Number(r[divisionSummaryColumns.yellowIr] || 0);
    divisionSummaryData[division].defYellowIr += Number(r[divisionSummaryColumns.defYellowIr] || 0);
    divisionSummaryData[division].alpRsValve += Number(r[divisionSummaryColumns.alpRsValve] || 0);
    divisionSummaryData[division].defAlpRsValve += Number(r[divisionSummaryColumns.defAlpRsValve] || 0);
    divisionSummaryData[division].memuSpeed += Number(r[divisionSummaryColumns.memuSpeed] || 0);
    divisionSummaryData[division].overspeeding += Number(r[divisionSummaryColumns.overspeeding] || 0);
    divisionSummaryData[division].ibsSignal += Number(r[divisionSummaryColumns.ibsSignal] || 0);
    divisionSummaryData[division].defIbsSignal += Number(r[divisionSummaryColumns.defIbsSignal] || 0);
    divisionSummaryData[division].runningRoom += Number(r[divisionSummaryColumns.runningRoom] || 0);
    divisionSummaryData[division].defRunningRoom += Number(r[divisionSummaryColumns.defRunningRoom] || 0);
    divisionSummaryData[division].stablingChecked += Number(r[divisionSummaryColumns.stablingChecked] || 0);
    divisionSummaryData[division].defStabling += Number(r[divisionSummaryColumns.defStabling] || 0);
    divisionSummaryData[division].shuntingChecked += Number(r[divisionSummaryColumns.shuntingChecked] || 0);
    divisionSummaryData[division].defShunting += Number(r[divisionSummaryColumns.defShunting] || 0);
  });

  const summaryHeader = document.getElementById('summaryHeader');
  const summaryBody = document.getElementById('summaryBody');
  const excelSummaryData = [];

  summaryHeader.innerHTML = `
    <th onclick="sortTable('sn')">SN</th>
    <th onclick="sortTable('category')">Category</th>
    <th onclick="sortTable('checks')">No of Checks Conducted</th>
    <th onclick="sortTable('deficiencies')">Deficiencies Noticed</th>
    <th onclick="sortTable('divisionsWithDef')">Divisions Deficiencies</th>
  `;

  summaryBody.innerHTML = '';
  if (summaryData.length === 0) {
    summaryBody.innerHTML = `<tr><td colspan="5">No data available for the selected filters.</td></tr>`;
  } else {
    summaryData.forEach(row => {
      const html = `
        <tr>
          <td>${row.sn}</td>
          <td>${row.category}</td>
          <td>${row.checks}</td>
          <td>${row.deficiencies}</td>
          <td>${row.divisionsWithDef}</td>
        </tr>
      `;
      summaryBody.insertAdjacentHTML('beforeend', html);
      excelSummaryData.push({
        SN: row.sn,
        Category: row.category,
        'No of Checks Conducted': row.checks,
        'Deficiencies Noticed': row.deficiencies,
        'Divisions Deficiencies': row.divisionsWithDef
      });
    });
  }

  const divisionSummaryTableHeader = document.getElementById('divisionSummaryTableHeader');
  const divisionSummaryTableBody = document.getElementById('divisionSummaryTableBody');
  const excelDivisionSummaryData = [];

  divisionSummaryTableHeader.innerHTML = `
    <th onclick="sortDivisionTable('division')">Division</th>
    <th onclick="sortDivisionTable('spm')">Total SPMs</th>
    <th onclick="sortDivisionTable('defSpm')">SPM Def.</th>
    <th onclick="sortDivisionTable('cvvrs')">Total CVVRS</th>
    <th onclick="sortDivisionTable('defCvvrs')">CVVRS Def.</th>
    <th onclick="sortDivisionTable('cugChecked')">CUG Checked</th>
    <th onclick="sortDivisionTable('cugMisused')">CUG Misused</th>
    <th onclick="sortDivisionTable('personalMobChecked')">Personal Mob. Checked</th>
    <th onclick="sortDivisionTable('personalMobMisused')">Personal Mob. Misused</th>
    <th onclick="sortDivisionTable('mobDeclaration')">Mob. Declaration</th>
    <th onclick="sortDivisionTable('mismatch')">Mismatch</th>
    <th onclick="sortDivisionTable('lobbyOnline')">Lobby + Online</th>
    <th onclick="sortDivisionTable('mobDef')">Mob. Def.</th>
    <th onclick="sortDivisionTable('yellowYellowDfc')">Ambush: Yellow-Yellow DFC</th>
    <th onclick="sortDivisionTable('defYellowYellowDfc')">Def: Yellow-Yellow DFC</th>
    <th onclick="sortDivisionTable('yellowIr')">Ambush: Yellow IR</th>
    <th onclick="sortDivisionTable('defYellowIr')">Def: Yellow IR</th>
    <th onclick="sortDivisionTable('alpRsValve')">ALP RS Valve Check</th>
    <th onclick="sortDivisionTable('defAlpRsValve')">Def: ALP RS Valve</th>
    <th onclick="sortDivisionTable('memuSpeed')">MEMU Speed at PF</th>
    <th onclick="sortDivisionTable('overspeeding')">OverSpeeding Cases</th>
    <th onclick="sortDivisionTable('ibsSignal')">IBS Signal Passed</th>
    <th onclick="sortDivisionTable('defIbsSignal')">Def: IBS Signal</th>
    <th onclick="sortDivisionTable('runningRoom')">Running Room (Wee Hours)</th>
    <th onclick="sortDivisionTable('defRunningRoom')">Def: Running Room</th>
    <th onclick="sortDivisionTable('stablingChecked')">Stabling Checked</th>
    <th onclick="sortDivisionTable('defStabling')">Def: Stabling</th>
    <th onclick="sortDivisionTable('shuntingChecked')">Shunting Checked</th>
    <th onclick="sortDivisionTable('defShunting')">Def: Shunting</th>
  `;

  divisionSummaryTableBody.innerHTML = '';
  if (showDivisionSummary) {
    const divisions = Object.keys(divisionSummaryData).sort((a, b) => divisionSummaryData[b].spm - divisionSummaryData[a].spm);
    if (divisions.length === 0) {
      divisionSummaryTableBody.innerHTML = `<tr><td colspan="29">No data available for the selected filters.</td></tr>`;
    } else {
      divisions.forEach(division => {
        const g = divisionSummaryData[division];
        const row = `
          <tr>
            <td>${division}</td>
            <td>${g.spm}</td>
            <td>${g.defSpm}</td>
            <td>${g.cvvrs}</td>
            <td>${g.defCvvrs}</td>
            <td>${g.cugChecked}</td>
            <td>${g.cugMisused}</td>
            <td>${g.personalMobChecked}</td>
            <td>${g.personalMobMisused}</td>
            <td>${g.mobDeclaration}</td>
            <td>${g.mismatch}</td>
            <td>${g.lobbyOnline}</td>
            <td>${g.mobDef}</td>
            <td>${g.yellowYellowDfc}</td>
            <td>${g.defYellowYellowDfc}</td>
            <td>${g.yellowIr}</td>
            <td>${g.defYellowIr}</td>
            <td>${g.alpRsValve}</td>
            <td>${g.defAlpRsValve}</td>
            <td>${g.memuSpeed}</td>
            <td>${g.overspeeding}</td>
            <td>${g.ibsSignal}</td>
            <td>${g.defIbsSignal}</td>
            <td>${g.runningRoom}</td>
            <td>${g.defRunningRoom}</td>
            <td>${g.stablingChecked}</td>
            <td>${g.defStabling}</td>
            <td>${g.shuntingChecked}</td>
            <td>${g.defShunting}</td>
          </tr>
        `;
        divisionSummaryTableBody.insertAdjacentHTML('beforeend', row);
        excelDivisionSummaryData.push({
          Division: division,
          'Total SPMs': g.spm,
          'SPM Def.': g.defSpm,
          'Total CVVRS': g.cvvrs,
          'CVVRS Def.': g.defCvvrs,
          'CUG Checked': g.cugChecked,
          'CUG Misused': g.cugMisused,
          'Personal Mob. Checked': g.personalMobChecked,
          'Personal Mob. Misused': g.personalMobMisused,
          'Mob. Declaration': g.mobDeclaration,
          Mismatch: g.mismatch,
          'Lobby + Online': g.lobbyOnline,
          'Mob. Def.': g.mobDef,
          'Ambush: Yellow-Yellow DFC': g.yellowYellowDfc,
          'Def: Yellow-Yellow DFC': g.defYellowYellowDfc,
          'Ambush: Yellow IR': g.yellowIr,
          'Def: Yellow IR': g.defYellowIr,
          'ALP RS Valve Check': g.alpRsValve,
          'Def: ALP RS Valve': g.defAlpRsValve,
          'MEMU Speed at PF': g.memuSpeed,
          'OverSpeeding Cases': g.overspeeding,
          'IBS Signal Passed': g.ibsSignal,
          'Def: IBS Signal': g.defIbsSignal,
          'Running Room (Wee Hours)': g.runningRoom,
          'Def: Running Room': g.defRunningRoom,
          'Stabling Checked': g.stablingChecked,
          'Def: Stabling': g.defStabling,
          'Shunting Checked': g.shuntingChecked,
          'Def: Shunting': g.defShunting
        });
      });
    }
  }

  const divisionCounts = {};
  const categoryCounts = {};
  categories.forEach(cat => categoryCounts[cat.name] = 0);
  const allRemarksData = [];
  const groupedRemarks = {};

  allData.slice(2).forEach(r => {
    const date = r[idx('Date')], division = r[1], remarks = r[31] || '', e_date = r[33] || '', action_taken = r[34] || '', status = r[35] || '';
    if (!division || !date) return;
    if (date < fromDate || date > toDate) return;
    if (selectedDivision && division !== selectedDivision) return;

    const hasDeficiency = deficiencyColumns.some(col => Number(r[col] || 0) > 0);
    if (!hasDeficiency) return;

    const key = `${date}_${division}`;
    if (!groupedRemarks[key]) {
      groupedRemarks[key] = { date, division, categories: [], remarks, e_date, action_taken, status };
    }

    summaryData.forEach(row => {
      const cat = categories.find(c => c.sn === row.sn);
      if (row.divisionsWithDef.split(', ').includes(division)) {
        const deficiency = Number(r[cat.defCol] || 0);
        if (deficiency > 0) {
          if (!groupedRemarks[key].categories.includes(cat.name)) {
            groupedRemarks[key].categories.push(cat.name);
            categoryCounts[cat.name] = (categoryCounts[cat.name] || 0) + 1;
            divisionCounts[division] = (divisionCounts[division] || 0) + 1;
          }
        }
      }
    });

    if (groupedRemarks[key].categories.length > 0) {
      allRemarksData.push({
        date,
        division,
        categories: groupedRemarks[key].categories,
        remarks,
        e_date,
        action_taken,
        status,
        class: groupedRemarks[key].categories.map(cat => categories.find(c => c.name === cat)?.class).join(' ')
      });
    }
  });

  const divisionButtons = document.getElementById('divisionButtons');
  const uniqueDivisions = [...new Set(summaryData.flatMap(row => row.divisionsWithDef.split(', ').filter(div => div !== 'None')))];
  divisionButtons.innerHTML = '';
  const allDivisionButton = document.createElement('button');
  allDivisionButton.className = `filter-btn ${buttonDivision === 'ALL' ? 'active' : ''}`;
  allDivisionButton.textContent = `ALL (${allRemarksData.length})`;
  allDivisionButton.addEventListener('click', () => {
    buttonDivision = 'ALL';
    currentPage = 1;
    renderTables();
  });
  divisionButtons.appendChild(allDivisionButton);
  uniqueDivisions.forEach(div => {
    const button = document.createElement('button');
    button.className = `filter-btn ${div === buttonDivision ? 'active' : ''}`;
    button.textContent = `${div} (${divisionCounts[div] || 0})`;
    button.addEventListener('click', () => {
      buttonDivision = div;
      currentPage = 1;
      renderTables();
    });
    divisionButtons.appendChild(button);
  });

  const categoryButtons = document.getElementById('categoryButtons');
  categoryButtons.innerHTML = '';
  const allCategoryButton = document.createElement('button');
  allCategoryButton.className = `filter-btn ${buttonCategory === 'ALL' ? 'active' : ''}`;
  allCategoryButton.textContent = `ALL (${allRemarksData.length})`;
  allCategoryButton.addEventListener('click', () => {
    buttonCategory = 'ALL';
    currentPage = 1;
    renderTables();
  });
  categoryButtons.appendChild(allCategoryButton);
  categories.forEach(cat => {
    const button = document.createElement('button');
    button.className = `filter-btn ${cat.name === buttonCategory ? 'active' : ''} ${cat.class}`;
    button.textContent = `${cat.name} (${categoryCounts[cat.name] || 0})`;
    button.addEventListener('click', () => {
      buttonCategory = cat.name;
      currentPage = 1;
      renderTables();
    });
    categoryButtons.appendChild(button);
  });

  const remarksHeader = document.getElementById('remarksHeader');
  const remarksBody = document.getElementById('remarksBody');
  const excelRemarksData = [];

  remarksHeader.innerHTML = `
    <th>Date</th>
    <th>Division</th>
    <th>Category</th>
    <th>Remarks</th>
    <th>E_Date</th>
    <th>Action Taken Remarks</th>
    <th>Status</th>
  `;

  remarksData = [];
  if (buttonDivision) {
    const selectedCategories = buttonCategory === 'ALL' ? categories.map(c => c.name) : [buttonCategory];
    const divisionsToShow = buttonDivision === 'ALL' ? uniqueDivisions : [buttonDivision];

    divisionsToShow.forEach(division => {
      const filteredData = allRemarksData.filter(row => row.division === division && (buttonCategory === 'ALL' || row.categories.includes(buttonCategory)));
      if (filteredData.length > 0) {
        if (buttonDivision === 'ALL') {
          remarksData.push({ isHeader: true, division });
        }
        remarksData.push(...filteredData);
      }
    });
  }

  remarksBody.innerHTML = '';
  if (remarksData.length === 0) {
    remarksBody.innerHTML = `<tr><td colspan="7">No remarks data available for the selected filters.</td></tr>`;
  } else {
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedData = remarksData.slice(start, end);
    paginatedData.forEach(row => {
      if (row.isHeader) {
        const html = `<tr><td colspan="7" class="division-group-header">${row.division}</td></tr>`;
        remarksBody.insertAdjacentHTML('beforeend', html);
      } else {
        const html = `
          <tr>
            <td>${row.date}</td>
            <td>${row.division}</td>
            <td class="${row.class}">${row.categories.join(', ')}</td>
            <td class="${row.class}">${row.remarks}</td>
            <td>${row.e_date}</td>
            <td>${row.action_taken}</td>
            <td>${row.status}</td>
          </tr>
        `;
        remarksBody.insertAdjacentHTML('beforeend', html);
      }
    });

    allRemarksData.forEach(row => {
      if (buttonCategory === 'ALL' || row.categories.includes(buttonCategory)) {
        if (buttonDivision === 'ALL' || row.division === buttonDivision) {
          excelRemarksData.push({
            Date: row.date,
            Division: row.division,
            Category: row.categories.join(', '),
            Remarks: row.remarks,
            E_Date: row.e_date,
            'Action Taken Remarks': row.action_taken,
            Status: row.status
          });
        }
      }
    });
  }

  const totalPages = Math.ceil(remarksData.length / rowsPerPage);
  document.getElementById('pageInfo').textContent = remarksData.length > 0 ? `Page ${currentPage} of ${totalPages}` : '';
  document.getElementById('prevPageBtn').classList.toggle('disabled', currentPage === 1);
  document.getElementById('nextPageBtn').classList.toggle('disabled', currentPage === totalPages || totalPages === 0);

  document.getElementById('excelBtn').dataset.excelSummaryData = JSON.stringify(excelSummaryData);
  document.getElementById('excelBtn').dataset.excelDivisionSummaryData = JSON.stringify(excelDivisionSummaryData);
  document.getElementById('excelBtn').dataset.excelRemarksData = JSON.stringify(excelRemarksData);
}

function sortTable(column) {
  summaryData.sort((a, b) => {
    if (column === 'sn' || column === 'checks' || column === 'deficiencies') {
      return a[column] - b[column];
    }
    return a[column].localeCompare(b[column]);
  });
  renderTables();
}

function sortDivisionTable(column) {
  const divisions = Object.keys(divisionSummaryData);
  divisions.sort((a, b) => {
    if (column === 'division') return a.localeCompare(b);
    return divisionSummaryData[b][column] - divisionSummaryData[a][column];
  });
  renderTables();
}

function exportToExcel() {
  try {
    const excelSummaryData = JSON.parse(document.getElementById('excelBtn').dataset.excelSummaryData || '[]');
    const excelDivisionSummaryData = JSON.parse(document.getElementById('excelBtn').dataset.excelDivisionSummaryData || '[]');
    const excelRemarksData = JSON.parse(document.getElementById('excelBtn').dataset.excelRemarksData || '[]');
    if (excelSummaryData.length === 0 && excelDivisionSummaryData.length === 0 && excelRemarksData.length === 0) {
      alert('No data available to export to Excel.');
      return;
    }
    const wb = XLSX.utils.book_new();
    if (excelSummaryData.length > 0) {
      const wsSummary = XLSX.utils.json_to_sheet(excelSummaryData);
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Category Summary');
    }
    if (excelDivisionSummaryData.length > 0) {
      const wsDivisionSummary = XLSX.utils.json_to_sheet(excelDivisionSummaryData);
      XLSX.utils.book_append_sheet(wb, wsDivisionSummary, 'Division Summary');
    }
    if (excelRemarksData.length > 0) {
      const wsRemarks = XLSX.utils.json_to_sheet(excelRemarksData);
      XLSX.utils.book_append_sheet(wb, wsRemarks, 'Remarks');
    }
    const today = new Date().toISOString().split('T')[0];
    XLSX.write(wb, `Crew_Summary_Remarks_${today}.xlsx`);
  } catch (err) {
    console.error('Excel Export Error:', err);
    alert('Failed to export Excel. Please check the console for details or try again.');
  }
}

async function showPdfPreview() {
  try {
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = '';

    const pageWidth = 297; // A4 landscape width in mm
    const pageHeight = 210; // A4 landscape height in mm
    const margin = pdfSettings.margin;
    const contentWidth = pageWidth - 2 * margin;
    const contentHeight = pageHeight - 2 * margin;
    const lineHeight = pdfSettings.fontSize * 0.3528 * 1.2;

    const header = document.querySelector('.header-buttons');
    const topBar = document.querySelector('.top-bar');
    const canvas = await html2canvas(document.body, {
      scale: 0.5,
      useCORS: true,
      dpi: 72,
      letterRendering: true,
      scrollX: 0,
      scrollY: 0,
      width: header.offsetWidth,
      height: header.offsetHeight + topBar.offsetHeight + 15
    });
    const imgWidth = contentWidth / 2;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let yOffset = margin + 10;
    let pageCount = 1;
    let content = [];

    const headerHeight = imgHeight * 2.835;
    content.push(`<strong>Header & Top Bar</strong> (${headerHeight.toFixed(1)}mm)<br><img src="${canvas.toDataURL('image/jpeg', 0.5)}" style="width:${imgWidth}px; height:${imgHeight}px;">`);
    yOffset += headerHeight;

    const summaryRows = summaryData.length + 1;
    const summaryHeight = summaryRows * lineHeight;
    if (yOffset + summaryHeight > contentHeight) {
      pageCount++;
      content.push('--- Page Break ---');
      yOffset = margin;
    }
    content.push(`<strong>Category Summary Table</strong> (${summaryRows} rows, ${summaryHeight.toFixed(1)}mm)`);
    yOffset += summaryHeight + 5;

    if (showDivisionSummary) {
      const divisionRows = Object.keys(divisionSummaryData).length + 1;
      const divisionHeight = divisionRows * lineHeight;
      if (yOffset + divisionHeight > contentHeight) {
        pageCount++;
        content.push('--- Page Break ---');
        yOffset = margin;
      }
      content.push(`<strong>Division Summary Table</strong> (${divisionRows} rows, ${divisionHeight.toFixed(1)}mm)`);
      yOffset += divisionHeight + 5;
    }

    const remarksRows = remarksData.length + (buttonDivision === 'ALL' ? new Set(remarksData.map(r => r.division)).size : 0);
    const remarksHeight = remarksRows * lineHeight;
    const remarksPages = Math.ceil((yOffset + remarksHeight) / contentHeight);
    content.push(`<strong>Remarks Table</strong> (${remarksRows} rows, ${remarksHeight.toFixed(1)}mm)`);
    pageCount += remarksPages - 1;

    const paginationHeight = 10;
    if (yOffset + paginationHeight > contentHeight) {
      pageCount++;
      content.push('--- Page Break ---');
    }
    const pagination = document.querySelector('.pagination');
    const paginationCanvas = await html2canvas(pagination, {
      scale: 0.5,
      useCORS: true,
      dpi: 72,
      letterRendering: true
    });
    const paginationImgWidth = contentWidth / 2;
    const paginationImgHeight = (paginationCanvas.height * paginationImgWidth) / paginationCanvas.width;
    content.push(`<strong>Pagination Controls</strong> (${paginationHeight.toFixed(1)}mm)<br><img src="${paginationCanvas.toDataURL('image/jpeg', 0.5)}" style="width:${paginationImgWidth}px; height:${paginationImgHeight}px;">`);

    let currentPage = 1;
    let pageContent = [];
    content.forEach(item => {
      if (item === '--- Page Break ---') {
        previewContent.insertAdjacentHTML('beforeend', `<div class="preview-page"><strong>Page ${currentPage}</strong><br>${pageContent.join('<br>')}</div>`);
        currentPage++;
        pageContent = [];
      } else {
        pageContent.push(item);
      }
    });
    if (pageContent.length > 0) {
      previewContent.insertAdjacentHTML('beforeend', `<div class="preview-page"><strong>Page ${currentPage}</strong><br>${pageContent.join('<br>')}</div>`);
    }

    const estimatedSize = (summaryRows + (showDivisionSummary ? Object.keys(divisionSummaryData).length : 0) + remarksRows) * 0.03 + 1.0;
    previewContent.insertAdjacentHTML('beforeend', `<p>Estimated File Size: ${estimatedSize.toFixed(1)} MB</p>`);

    document.getElementById('pdfPreviewModal').style.display = 'flex';
  } catch (err) {
    console.error('PDF Preview Error:', err);
    alert('Failed to generate PDF preview. Please check the console for details or try again.');
  }
}

async function exportToPDF() {
  try {
    document.getElementById('pdfPreviewModal').style.display = 'none';
    const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = pdfSettings.margin;
    const contentWidth = pageWidth - 2 * margin;

    if (!summaryData.length && !remarksData.length) {
      alert('No data available to export to PDF.');
      return;
    }

    const header = document.querySelector('.header-buttons');
    const topBar = document.querySelector('.top-bar');
    const canvas = await html2canvas(document.body, {
      scale: 1.0,
      useCORS: true,
      dpi: 96,
      letterRendering: true,
      scrollX: 0,
      scrollY: 0,
      width: header.offsetWidth,
      height: header.offsetHeight + topBar.offsetHeight + 15
    });
    const imgWidth = contentWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    const quality = canvas.width * canvas.height > 5000000 ? 0.6 : 0.7;
    doc.addImage(canvas.toDataURL('image/jpeg', quality), 'JPEG', margin, margin, imgWidth, imgHeight);

    let yOffset = margin + imgHeight + 5;

    doc.setFont('Roboto', 'normal');
    doc.setFontSize(pdfSettings.fontSize);
    doc.text('Category Summary', pageWidth / 2, yOffset, { align: 'center' });
    yOffset += 4;
    doc.autoTable({
      startY: yOffset,
      head: [['SN', 'Category', 'No of Checks Conducted', 'Deficiencies Noticed', 'Divisions Deficiencies']],
      body: summaryData.map(row => [row.sn, row.category, row.checks, row.deficiencies, row.divisionsWithDef]),
      theme: 'grid',
      styles: {
        font: 'Roboto',
        fontSize: pdfSettings.fontSize,
        textColor: [26, 26, 26],
        lineColor: [224, 230, 239],
        lineWidth: 0.2,
        cellPadding: 0.5,
        overflow: 'linebreak',
        minCellHeight: pdfSettings.fontSize * 0.3528 * 1.2,
        rowPageBreak: 'avoid'
      },
      headStyles: {
        fillColor: [0, 116, 217],
        textColor: [255, 255, 255]
      },
      alternateRowStyles: {
        fillColor: [248, 250, 252]
      },
      columnStyles: {
        0: { cellWidth: 'auto' },
        1: { cellWidth: 'auto' },
        2: { cellWidth: 'auto' },
        3: { cellWidth: 'auto' },
        4: { cellWidth: 'auto' }
      },
      didParseCell: (data) => {
        if (data.section === 'body') {
          data.cell.styles.cellWidth = Math.max(60 / 2.835 * pdfSettings.columnWidthMultiplier, data.cell.raw.toString().length * pdfSettings.fontSize * 0.1);
        }
      },
      margin: { top: margin, left: margin, right: margin }
    });
    yOffset = doc.lastAutoTable.finalY + 5;

    if (showDivisionSummary) {
      doc.text('Division-Based Summary', pageWidth / 2, yOffset, { align: 'center' });
      yOffset += 4;
      doc.autoTable({
        startY: yOffset,
        head: [['Division', 'Total SPMs', 'SPM Def.', 'Total CVVRS', 'CVVRS Def.', 'CUG Checked', 'CUG Misused', 'Personal Mob. Checked', 'Personal Mob. Misused', 'Mob. Declaration', 'Mismatch', 'Lobby + Online', 'Mob. Def.', 'Ambush: Yellow-Yellow DFC', 'Def: Yellow-Yellow DFC', 'Ambush: Yellow IR', 'Def: Yellow IR', 'ALP RS Valve Check', 'Def: ALP RS Valve', 'MEMU Speed at PF', 'OverSpeeding Cases', 'IBS Signal Passed', 'Def: IBS Signal', 'Running Room (Wee Hours)', 'Def: Running Room', 'Stabling Checked', 'Def: Stabling', 'Shunting Checked', 'Def: Shunting']],
        body: Object.keys(divisionSummaryData).map(division => {
          const g = divisionSummaryData[division];
          return [division, g.spm, g.defSpm, g.cvvrs, g.defCvvrs, g.cugChecked, g.cugMisused, g.personalMobChecked, g.personalMobMisused, g.mobDeclaration, g.mismatch, g.lobbyOnline, g.mobDef, g.yellowYellowDfc, g.defYellowYellowDfc, g.yellowIr, g.defYellowIr, g.alpRsValve, g.defAlpRsValve, g.memuSpeed, g.overspeeding, g.ibsSignal, g.defIbsSignal, g.runningRoom, g.defRunningRoom, g.stablingChecked, g.defStabling, g.shuntingChecked, g.defShunting];
        }),
        theme: 'grid',
        styles: {
          font: 'Roboto',
          fontSize: pdfSettings.fontSize,
          textColor: [26, 26, 26],
          lineColor: [224, 230, 239],
          lineWidth: 0.2,
          cellPadding: 0.5,
          overflow: 'linebreak',
          minCellHeight: pdfSettings.fontSize * 0.3528 * 1.2,
          rowPageBreak: 'avoid'
        },
        headStyles: {
          fillColor: [0, 116, 217],
          textColor: [255, 255, 255]
        },
        alternateRowStyles: {
          fillColor: [248, 250, 252]
        },
        columnStyles: Object.fromEntries(Array(29).fill().map((_, i) => [i, { cellWidth: 'auto' }])),
        didParseCell: (data) => {
          if (data.section === 'body') {
            data.cell.styles.cellWidth = Math.max(60 / 2.835 * pdfSettings.columnWidthMultiplier, data.cell.raw.toString().length * pdfSettings.fontSize * 0.1);
          }
        },
        margin: { top: margin, left: margin, right: margin }
      });
      yOffset = doc.lastAutoTable.finalY + 5;
    }

    doc.text('Remarks Details', pageWidth / 2, yOffset, { align: 'center' });
    yOffset += 4;
    const remarksTableData = [];
    remarksData.forEach(row => {
      if (row.isHeader) {
        remarksTableData.push([{ content: row.division, colSpan: 7, styles: { fillColor: [224, 230, 239], textColor: [26, 26, 26], fontStyle: 'bold', halign: 'left' } }]);
      } else {
        const catClass = row.class.split(' ')[0] || 'cat-spm';
        const fillColor = {
          'cat-spm': [230, 243, 255],
          'cat-cvvrs': [230, 255, 230],
          'cat-cug': [255, 230, 230],
          'cat-personal-mob': [255, 245, 230],
          'cat-mob-declaration': [230, 230, 255],
          'cat-lobby-online': [240, 230, 255],
          'cat-yellow-dfc': [255, 255, 230],
          'cat-yellow-ir': [230, 255, 240],
          'cat-alp-rs': [255, 230, 240],
          'cat-memu-speed': [230, 250, 255],
          'cat-ibs-signal': [240, 255, 230],
          'cat-running-room': [255, 230, 255],
          'cat-stabling': [230, 240, 255],
          'cat-shunting': [255, 250, 230]
        }[catClass] || [255, 255, 255];
        remarksTableData.push([
          { content: row.date },
          { content: row.division },
          { content: row.categories.join(', '), styles: { fillColor } },
          { content: row.remarks, styles: { fillColor } },
          { content: row.e_date },
          { content: row.action_taken },
          { content: row.status }
        ]);
      }
    });
    doc.autoTable({
      startY: yOffset,
      head: [['Date', 'Division', 'Category', 'Remarks', 'E_Date', 'Action Taken Remarks', 'Status']],
      body: remarksTableData,
      theme: 'grid',
      styles: {
        font: 'Roboto',
        fontSize: pdfSettings.fontSize,
        textColor: [26, 26, 26],
        lineColor: [224, 230, 239],
        lineWidth: 0.2,
        cellPadding: 0.5,
        overflow: 'linebreak',
        minCellHeight: pdfSettings.fontSize * 0.3528 * 1.2,
        rowPageBreak: 'avoid'
      },
      headStyles: {
        fillColor: [0, 116, 217],
        textColor: [255, 255, 255]
      },
      alternateRowStyles: {
        fillColor: [248, 250, 252]
      },
      columnStyles: {
        0: { cellWidth: 'auto' },
        1: { cellWidth: 'auto' },
        2: { cellWidth: 'auto' },
        3: { cellWidth: 'auto' },
        4: { cellWidth: 'auto' },
        5: { cellWidth: 'auto' },
        6: { cellWidth: 'auto' }
      },
      didParseCell: (data) => {
        if (data.section === 'body' && !data.row.cells[0].styles.fillColor) {
          data.cell.styles.cellWidth = Math.max(60 / 2.835 * pdfSettings.columnWidthMultiplier, data.cell.raw.toString().length * pdfSettings.fontSize * 0.1);
        }
      },
      margin: { top: margin, left: margin, right: margin }
    });
    yOffset = doc.lastAutoTable.finalY + 5;

    const pagination = document.querySelector('.pagination');
    const paginationCanvas = await html2canvas(pagination, {
      scale: 1.0,
      useCORS: true,
      dpi: 96,
      letterRendering: true
    });
    const paginationImgWidth = contentWidth;
    const paginationImgHeight = (paginationCanvas.height * paginationImgWidth) / paginationCanvas.width;
    if (yOffset + paginationImgHeight > pageHeight - margin) {
      doc.addPage();
      yOffset = margin;
    }
    doc.addImage(paginationCanvas.toDataURL('image/jpeg', quality), 'JPEG', margin, yOffset, paginationImgWidth, paginationImgHeight);

    const today = new Date().toISOString().split('T')[0];
    doc.save(`Crew_Summary_Remarks_${today}.pdf`);
  } catch (err) {
    console.error('PDF Export Error:', err);
    alert('Failed to export PDF. Please check the console for details or try again.');
  }
}
</script>
</body>
</html>
